<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Müzik Dünyam - Akıllı Akış</title>
    <style>
        :root { --bg-color: #000; --accent: #1db954; --text: #fff; }
        body { background: var(--bg-color); color: var(--text); font-family: -apple-system, sans-serif; margin: 0; padding-bottom: 160px; transition: background 1.5s ease; }
        .bg-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(180deg, transparent 0%, rgba(0,0,0,0.8) 100%); z-index: -1; }
        .app-branding { padding: 50px 20px 10px; }
        .header { padding: 15px 20px; position: sticky; top: 0; background: rgba(0,0,0,0.5); backdrop-filter: blur(20px); z-index: 1000; display: flex; gap: 10px; align-items: center; }
        input { flex: 1; padding: 12px; border-radius: 12px; border: none; background: #222; color: #fff; }
        .album-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; padding: 15px; }
        .album-card { background: rgba(255,255,255,0.08); border-radius: 15px; overflow: hidden; }
        .album-card img { width: 100%; aspect-ratio: 1; object-fit: cover; }
        .song-list { padding: 15px; }
        .song-row { display: flex; align-items: center; padding: 12px; margin-bottom: 8px; background: rgba(255,255,255,0.08); border-radius: 12px; }
        .song-row img { width: 45px; height: 45px; border-radius: 6px; margin-right: 12px; }
        .footer-player { position: fixed; bottom: 0; width: 100%; background: rgba(0,0,0,0.8); backdrop-filter: blur(30px); padding: 15px 20px 40px; display: flex; align-items: center; border-top: 1px solid #333; z-index: 2000; box-sizing: border-box; }
        .footer-player img { width: 50px; height: 50px; border-radius: 8px; margin-right: 12px; }
        .play-pause-btn { background: #fff; border: none; border-radius: 50%; width: 45px; height: 45px; font-size: 18px; }
        #yt-player { display: none; }
        .back-btn { background: none; border: none; color: var(--accent); font-weight: bold; display: none; }
    </style>
</head>
<body>

<div class="bg-overlay"></div>
<div class="app-branding" id="brand-area"><h1>Müzik Dünyam</h1></div>

<div class="header">
    <button id="mainBackBtn" class="back-btn" onclick="goBack()">← Geri</button>
    <input type="text" id="searchInput" placeholder="Şarkı veya sanatçı..." onkeyup="if(event.key==='Enter') searchAlbums(this.value)">
    <div onclick="showFavorites()" style="color:#ff2d55; font-size:24px;">♥</div>
</div>

<div id="mainContent">
    <h3 id="viewTitle" style="padding-left: 20px;">Popüler Albümler</h3>
    <div id="displayArea" class="album-grid"></div>
</div>

<div class="footer-player">
    <img id="current-img" src="https://via.placeholder.com/50">
    <div style="flex: 1; overflow: hidden; margin-right: 10px;">
        <div id="current-title" style="font-size: 14px; font-weight: bold; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">Şarkı Seçin</div>
        <div id="current-artist" style="font-size: 12px; color: #aaa;">Keşfetmeye Hazır</div>
    </div>
    <button class="play-pause-btn" onclick="togglePlayback()" id="playBtn">▶</button>
</div>

<div id="yt-player"></div>
<canvas id="colorCanvas" style="display:none;"></canvas>

<script src="https://www.youtube.com/iframe_api"></script>
<script>
    const YT_API_KEY = "AIzaSyAkWmhLagzkGE_tNUfg7W1jzeWnKdMv1rg";
    let player;
    let favorites = JSON.parse(localStorage.getItem('favs')) || [];

    function onYouTubeIframeAPIReady() {
        player = new YT.Player('yt-player', {
            height: '0', width: '0',
            playerVars: { 'autoplay': 1, 'playsinline': 1, 'rel': 1 },
            events: {
                'onStateChange': onPlayerStateChange
            }
        });
    }

    function onPlayerStateChange(event) {
        document.getElementById('playBtn').innerText = (event.data === 1) ? "⏸" : "▶";
        
        // AKILLI SIRALAMA BURADA ÇALIŞIR:
        // Şarkı bittiğinde (0), YouTube'un "Benzer Videolar" listesindeki ilk videoyu çeker
        if (event.data === YT.PlayerState.ENDED) {
            // Player'ın otomatik olarak benzer videoya geçmesini bekle veya manuel tetikle
            // Çoğu durumda rel:1 ile YouTube benzerine geçer. Bilgileri güncellemek için:
            updateFooterWithNewVideo();
        }
    }

    // YouTube benzer şarkıya geçtiğinde arayüzü günceller
    function updateFooterWithNewVideo() {
        setTimeout(() => {
            const videoData = player.getVideoData();
            if (videoData) {
                document.getElementById('current-title').innerText = videoData.title;
                document.getElementById('current-artist').innerText = videoData.author;
                // Benzer şarkıda albüm kapağı YouTube'dan gelir
                document.getElementById('current-img').src = `https://img.youtube.com/vi/${player.getVideoId()}/default.jpg`;
            }
        }, 1000);
    }

    function togglePlayback() {
        if(player.getPlayerState() === 1) player.pauseVideo(); else player.playVideo();
    }

    // Hiyerarşik Gezinti
    function goBack() {
        document.getElementById('mainBackBtn').style.display = 'none';
        document.getElementById('brand-area').style.display = 'block';
        searchAlbums('2025 popular albums Turkey');
    }

    async function searchAlbums(query) {
        const url = `https://itunes.apple.com/search?term=${encodeURIComponent(query)}&entity=album&limit=16&country=tr`;
        const res = await fetch(url);
        const data = await res.json();
        renderAlbums(data.results);
    }

    function renderAlbums(albums) {
        const area = document.getElementById('displayArea');
        area.className = "album-grid";
        document.getElementById('viewTitle').innerText = "Albümler";
        area.innerHTML = albums.map(a => `
            <div class="album-card" onclick="loadAlbumTracks(${a.collectionId}, '${a.collectionName.replace(/'/g,"")}', '${a.artworkUrl100.replace('100x100bb','600x600bb')}')">
                <img src="${a.artworkUrl100.replace('100x100bb','300x300bb')}">
                <h4 style="font-size:13px; margin:10px;">${a.collectionName}</h4>
            </div>
        `).join('');
    }

    async function loadAlbumTracks(id, name, img) {
        document.getElementById('mainBackBtn').style.display = 'inline';
        document.getElementById('brand-area').style.display = 'none';
        document.getElementById('viewTitle').innerText = name;
        const res = await fetch(`https://itunes.apple.com/lookup?id=${id}&entity=song&country=tr`);
        const data = await res.json();
        const tracks = data.results.filter(i => i.wrapperType === 'track');
        renderSongs(tracks, img);
    }

    function renderSongs(tracks, img) {
        const area = document.getElementById('displayArea');
        area.className = "song-list";
        area.innerHTML = tracks.map(t => `
            <div class="song-row" onclick="playSong('${t.artistName}', '${t.trackName}', '${img}')">
                <img src="${img}">
                <div style="flex:1"><h4>${t.trackName}</h4><p style="font-size:12px;color:#888">${t.artistName}</p></div>
                <div onclick="event.stopPropagation(); toggleFav('${t.trackName}', '${t.artistName}', '${img}')" style="color:#555">♥</div>
            </div>
        `).join('');
    }

    async function playSong(artist, title, img) {
        document.getElementById('current-title').innerText = "Aranıyor...";
        const q = encodeURIComponent(`${artist} ${title} official audio`);
        const res = await fetch(`https://www.googleapis.com/youtube/v3/search?part=snippet&q=${q}&key=${YT_API_KEY}&type=video&maxResults=1`);
        const data = await res.json();
        
        if(data.items[0]) {
            const videoId = data.items[0].id.videoId;
            player.loadVideoById(videoId);
            document.getElementById('current-img').src = img;
            document.getElementById('current-title').innerText = title;
            document.getElementById('current-artist').innerText = artist;
            extractColor(img);
        }
    }

    // FAVORİ VE RENK FONKSİYONLARI (Kısaltılmış)
    function toggleFav(t, a, i) {
        favorites.push({title:t, artist:a, img:i});
        localStorage.setItem('favs', JSON.stringify(favorites));
        alert("Favorilere eklendi!");
    }

    function showFavorites() {
        document.getElementById('viewTitle').innerText = "Favorilerim";
        renderSongs(favorites, ''); // Favorilerdeki resimleri kullanır
    }

    function extractColor(url) {
        const img = new Image(); img.crossOrigin = "Anonymous"; img.src = url;
        img.onload = () => {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            canvas.width = 5; canvas.height = 5;
            ctx.drawImage(img, 0, 0, 5, 5);
            const d = ctx.getImageData(0,0,5,5).data;
            document.body.style.background = `rgb(${d[0]/4},${d[1]/4},${d[2]/4})`;
        }
    }

    window.onload = () => searchAlbums('2025 popular albums Turkey');
</script>
</body>
</html>
