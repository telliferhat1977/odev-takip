<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SinemaTV Ultra v32.0</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root { --n-red: #E50914; --n-black: #080808; }
        body { background-color: var(--n-black); color: white; font-family: 'Segoe UI', sans-serif; margin: 0; padding: 10px; overflow-x: hidden; }
        .nav-item { transition: all 0.2s; cursor: pointer; border: 2px solid transparent; outline: none; border-radius: 12px; }
        .nav-item:focus { border-color: white !important; background-color: var(--n-red) !important; transform: scale(1.05); }
        .full-modal { display: none !important; position: fixed; inset: 0; background: rgba(0,0,0,0.95); padding: 20px; overflow-y: auto; z-index: 1000; }
        .show-modal { display: flex !important; flex-direction: column; align-items: center; }
        #videoLayer { z-index: 4000; position: fixed; inset: 0; background: black; display: none; flex-direction: column; }
        #results, #historyBox, #favBox { display: flex; overflow-x: auto; gap: 12px; padding: 10px 5px; scrollbar-width: none; }
        .section-title { font-size: 12px; font-weight: 800; text-transform: uppercase; color: #555; margin-top: 15px; padding-left: 5px; display: flex; align-items: center; gap: 8px; }
        .card { flex: 0 0 110px; position: relative; }
        .card img { width: 110px; height: 165px; object-cover: cover; border-radius: 10px; }
    </style>
</head>
<body onload="initApp()">

    <div id="mainUI">
        <header class="flex flex-col items-center mb-4 text-center">
            <h1 class="text-3xl font-black text-[#E50914] italic mb-3">Sinema<span class="text-white">TV ULTRA</span></h1>
            <div class="flex w-full gap-2 px-2">
                <input type="text" id="searchInput" placeholder="Film, Dizi veya Oyuncu..." class="nav-item bg-[#1a1a1a] p-3 flex-1 rounded-xl outline-none text-sm border-none text-white">
                <button onclick="searchContent()" class="nav-item bg-[#E50914] px-5 py-3 rounded-xl font-bold text-xs"><i class="fas fa-search"></i></button>
            </div>
        </header>

        <div id="historySection" class="hidden">
            <div class="section-title"><i class="fas fa-history text-red-600"></i> Son İzlenenler</div>
            <div id="historyBox"></div>
        </div>

        <div id="favSection" class="hidden">
            <div class="section-title"><i class="fas fa-heart text-red-600"></i> Favorilerim</div>
            <div id="favBox"></div>
        </div>

        <div class="section-title"><i class="fas fa-fire text-red-600"></i> Trend Listesi</div>
        <div id="results"></div>
    </div>

    <div id="detailPage" class="full-modal">
        <div class="w-full max-w-4xl flex flex-col items-center">
            <div class="flex w-full justify-between mb-6">
                <button onclick="closeDetail()" class="nav-item bg-white/10 w-12 h-12 rounded-full flex items-center justify-center"><i class="fas fa-chevron-left"></i></button>
                <button id="favBtn" class="nav-item bg-white/10 w-12 h-12 rounded-full flex items-center justify-center text-xl"><i class="far fa-heart"></i></button>
            </div>
            
            <img id="detailPoster" src="" class="mb-4 max-h-[300px] rounded-2xl shadow-2xl border-2 border-white/5">
            <h2 id="detailTitle" class="text-2xl font-black mb-1 text-center"></h2>
            <div id="castList" class="flex flex-wrap justify-center gap-2 mb-8 px-4 opacity-70"></div>
            
            <button onclick="startAutoPlay()" class="nav-item bg-[#E50914] w-full max-w-xs py-5 rounded-2xl font-black text-lg uppercase shadow-lg shadow-red-900/20">
                <i class="fas fa-play mr-2"></i> ŞİMDİ İZLE
            </button>
        </div>
    </div>

    <div id="videoLayer">
        <div class="p-3 bg-black flex justify-between items-center border-b border-white/10">
            <button onclick="closePlayer()" class="nav-item bg-white/10 px-6 py-2 rounded-full font-bold text-[10px] uppercase">← KAPAT</button>
            <div id="playerTitle" class="text-[9px] text-gray-500 font-bold uppercase truncate px-4">Otomatik TR Altyazı Aktif</div>
        </div>
        <iframe id="playerFrame" src="" class="flex-1 w-full border-none" allowfullscreen></iframe>
    </div>

    <script>
        const TMDB_KEY = "847629da5649502fa6655f73b15a5c8e";   // kendi API anahtarını koy
        let currentItem = {}, currentS = 1, currentE = 1, menuStack = [];
        let history = JSON.parse(localStorage.getItem('stv_history') || '[]');
        let favorites = JSON.parse(localStorage.getItem('stv_favs') || '[]');

        function initApp() {
            loadShowcase();
            renderLists();
        }

        async function loadShowcase() {
            const res = await fetch(`https://api.themoviedb.org/3/trending/all/day?api_key=${TMDB_KEY}&language=tr-TR`);
            const data = await res.json();
            displayItems(data.results, 'results');
        }

        async function searchContent() {
            const q = document.getElementById('searchInput').value;
            if(!q) return loadShowcase();
            const res = await fetch(`https://api.themoviedb.org/3/search/multi?api_key=${TMDB_KEY}&query=${encodeURIComponent(q)}&language=tr-TR`);
            const data = await res.json();
            displayItems(data.results, 'results');
        }

        function displayItems(items, targetId) {
            const container = document.getElementById(targetId);
            container.innerHTML = "";
            items.forEach(item => {
                if(!item.poster_path) return;
                const div = document.createElement('div');
                div.className = "card card-item nav-item";
                div.innerHTML = `
                    <img src="https://image.tmdb.org/t/p/w300${item.poster_path}">
                    <div class="text-[10px] font-bold truncate mt-1">${item.title || item.name}</div>
                `;
                div.onclick = () => openDetails(item.id, item.media_type || (item.first_air_date ? 'tv' : 'movie'));
                container.appendChild(div);
            });
        }

        async function openDetails(id, type) {
            const res = await fetch(`https://api.themoviedb.org/3/${type}/${id}?api_key=${TMDB_KEY}&language=tr-TR&append_to_response=credits`);
            const data = await res.json();
            
            currentItem = { id, type, title: data.title || data.name, poster: data.poster_path };
            
            document.getElementById('detailTitle').innerText = currentItem.title;
            document.getElementById('detailPoster').src = `https://image.tmdb.org/t/p/w500${data.poster_path}`;
            
            const castDiv = document.getElementById('castList'); castDiv.innerHTML = "";
            data.credits.cast.slice(0, 5).forEach(a => {
                const s = document.createElement('span');
                s.className = "text-[10px]";
                s.innerText = a.name + (a === data.credits.cast.slice(0, 5)[4] ? "" : " • ");
                castDiv.appendChild(s);
            });

            updateFavBtn();
            document.getElementById('detailPage').classList.add('show-modal');
        }

        function startAutoPlay() {
            if(currentItem.type === 'tv') {
                // Dizi ise sezon seçimine gerek kalmadan 1. Sezon 1. Bölümden başlatıyoruz (veya kullanıcı seçimi eklenebilir)
                playStream(currentItem.id, 'tv', 1, 1);
            } else {
                playStream(currentItem.id, 'movie');
            }
            addToHistory(currentItem);
        }

        function playStream(id, type, s = 1, e = 1) {
            // Senin paylaştığın vidsrc.me API'si ve ds_lang=tr parametresi
            const url = type === 'tv' 
                ? `https://vidsrc.me/embed/tv?tmdb=${id}&sea=${s}&epi=${e}&ds_lang=tr`
                : `https://vidsrc.me/embed/movie?tmdb=${id}&ds_lang=tr`;
            
            document.getElementById('playerFrame').src = url;
            document.getElementById('videoLayer').style.display = 'flex';
        }

        // GEÇMİŞ VE FAVORİ MANTIĞI
        function addToHistory(item) {
            history = history.filter(h => h.id !== item.id);
            history.unshift(item);
            if(history.length > 15) history.pop();
            localStorage.setItem('stv_history', JSON.stringify(history));
            renderLists();
        }

        document.getElementById('favBtn').onclick = () => {
            const index = favorites.findIndex(f => f.id === currentItem.id);
            if(index > -1) favorites.splice(index, 1);
            else favorites.unshift(currentItem);
            localStorage.setItem('stv_favs', JSON.stringify(favorites));
            updateFavBtn();
            renderLists();
        };

        function updateFavBtn() {
            const isFav = favorites.some(f => f.id === currentItem.id);
            const btn = document.getElementById('favBtn');
            btn.innerHTML = isFav ? '<i class="fas fa-heart text-red-600"></i>' : '<i class="far fa-heart"></i>';
        }

        function renderLists() {
            if(history.length > 0) {
                document.getElementById('historySection').classList.remove('hidden');
                displayItems(history, 'historyBox');
            }
            if(favorites.length > 0) {
                document.getElementById('favSection').classList.remove('hidden');
                displayItems(favorites, 'favBox');
            }
        }

        function closeDetail() { document.getElementById('detailPage').classList.remove('show-modal'); }
        function closePlayer() { document.getElementById('playerFrame').src = ""; document.getElementById('videoLayer').style.display = 'none'; }
        
        window.onpopstate = () => {
            if(document.getElementById('videoLayer').style.display === 'flex') closePlayer();
            else closeDetail();
        };
    </script>
</body>
</html>
