<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Müzik Dünyam">
    <link rel="apple-touch-icon" href="https://img.icons8.com/plasticine/200/music--v1.png">
    <title>Müzik Dünyam</title>
    
    <style>
        :root { --bg: #000000; --card: #121212; --accent: #1db954; --text: #ffffff; --fav: #ff2d55; }
        body { 
            background: var(--bg); color: var(--text); font-family: -apple-system, sans-serif; 
            margin: 0; padding-top: env(safe-area-inset-top); padding-bottom: 140px; overflow-x: hidden;
        }
        
        .header { padding: 20px; position: sticky; top: 0; background: rgba(0,0,0,0.85); backdrop-filter: blur(15px); z-index: 1000; }
        input { 
            width: 100%; padding: 15px; border-radius: 12px; border: none; background: #222; 
            color: white; font-size: 17px; outline: none; box-sizing: border-box; 
        }

        #suggestion { color: var(--accent); padding: 10px; font-size: 14px; display: none; cursor: pointer; text-align: center; font-weight: bold; }
        .nav-tabs { display: flex; gap: 20px; margin-top: 15px; font-size: 14px; font-weight: bold; }
        .nav-tabs span { cursor: pointer; opacity: 0.6; }
        .nav-tabs span.active { opacity: 1; color: var(--accent); }

        .artist-poster { 
            width: 100%; height: 35vh; object-fit: cover; display: none; 
            mask-image: linear-gradient(to bottom, black 60%, transparent 100%);
            -webkit-mask-image: linear-gradient(to bottom, black 60%, transparent 100%);
        }

        .container { padding: 15px; }
        .song-row { display: flex; align-items: center; padding: 12px; margin-bottom: 10px; background: var(--card); border-radius: 12px; }
        .song-row img { width: 55px; height: 55px; border-radius: 8px; margin-right: 15px; }
        .info { flex: 1; overflow: hidden; }
        .info h4 { margin: 0; font-size: 15px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .info p { margin: 4px 0 0; color: #888; font-size: 12px; }
        
        .fav-btn { padding: 10px; font-size: 22px; color: #333; transition: 0.2s; }
        .fav-btn.active { color: var(--fav); }

        .footer-player { 
            position: fixed; bottom: 0; width: 100%; background: rgba(20,20,20,0.98); 
            backdrop-filter: blur(20px); padding: 15px 20px calc(20px + env(safe-area-inset-bottom)); 
            display: flex; align-items: center; border-top: 1px solid #333; z-index: 2000; box-sizing: border-box; 
        }
        .footer-player img { width: 50px; height: 50px; border-radius: 6px; margin-right: 15px; }
        .play-pause-btn { 
            background: var(--text); border: none; border-radius: 50%; width: 45px; height: 45px; 
            color: black; font-size: 18px; display: flex; align-items: center; justify-content: center; 
            cursor: pointer; margin-left: 10px; flex-shrink: 0;
        }
        #yt-player { display: none; }
    </style>
</head>
<body>

<div class="header">
    <input type="text" id="searchInput" placeholder="Sanatçı, şarkı veya söz..." onkeyup="if(event.key==='Enter') searchDeezer(this.value)">
    <div id="suggestion"></div>
    <div class="nav-tabs">
        <span id="tab-explore" class="active" onclick="location.reload()">Keşfet</span>
        <span id="tab-favs" onclick="renderFavorites()">Favorilerim</span>
    </div>
</div>

<img id="artist-poster" class="artist-poster">

<div class="container" id="content">
    <h3 id="viewTitle">Popüler</h3>
    <div id="list"></div>
</div>

<div class="footer-player">
    <img id="current-img" src="https://via.placeholder.com/50">
    <div style="flex: 1; overflow: hidden;">
        <div id="current-title" style="font-size: 14px; font-weight: bold; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">Şarkı Seçilmedi</div>
        <div id="current-artist" style="font-size: 12px; color: #aaa;">Müzik Dünyam</div>
    </div>
    <button class="play-pause-btn" onclick="togglePlayback()" id="playBtn">▶</button>
    <div id="yt-player"></div>
</div>

<script src="https://www.youtube.com/iframe_api"></script>
<script>
    const YT_API_KEY = "AIzaSyA_gvj_jfhsVllhikgjfrdYSUiX_U5MGS4";
    const PROXY = "https://api.allorigins.win/get?url=";
    let player;
    let favorites = JSON.parse(localStorage.getItem('myFavorites')) || [];

    function onYouTubeIframeAPIReady() {
        player = new YT.Player('yt-player', {
            height: '0', width: '0', videoId: '',
            events: { 'onStateChange': onPlayerStateChange }
        });
    }

    function onPlayerStateChange(event) {
        const btn = document.getElementById('playBtn');
        if (event.data === YT.PlayerState.PLAYING) btn.innerText = "⏸";
        else btn.innerText = "▶";
    }

    function togglePlayback() {
        if (!player) return;
        const state = player.getPlayerState();
        if (state === 1) player.pauseVideo();
        else player.playVideo();
    }

    async function searchDeezer(query) {
        const url = encodeURIComponent(`https://api.deezer.com/search?q=${query}`);
        const res = await fetch(PROXY + url);
        const data = JSON.parse((await res.json()).contents);
        
        if(data.data.length > 0) {
            const first = data.data[0];
            if(query.toLowerCase() !== first.artist.name.toLowerCase()) {
                const sug = document.getElementById('suggestion');
                sug.style.display = 'block';
                sug.innerText = `Bunu mu demek istediniz: ${first.artist.name}?`;
                sug.onclick = () => { 
                    searchArtistDetail(first.artist.id, first.artist.name, first.artist.picture_xl);
                    sug.style.display = 'none';
                };
            }
            renderList(data.data, "Sonuçlar");
        }
    }

    async function searchArtistDetail(id, name, img) {
        const poster = document.getElementById('artist-poster');
        poster.src = img;
        poster.style.display = 'block';
        const url = encodeURIComponent(`https://api.deezer.com/artist/${id}/top?limit=30`);
        const res = await fetch(PROXY + url);
        const data = JSON.parse((await res.json()).contents);
        renderList(data.data, `${name} - En İyiler`);
    }

    function renderList(songs, title) {
        document.getElementById('viewTitle').innerText = title;
        const listDiv = document.getElementById('list');
        listDiv.innerHTML = songs.map(song => {
            const isFav = favorites.some(f => f.id === song.id);
            const songData = JSON.stringify(song).replace(/"/g, '&quot;');
            return `
            <div class="song-row">
                <img src="${song.album.cover_medium}" onclick="playSong('${song.artist.name} ${song.title}', '${song.title}', '${song.artist.name}', '${song.album.cover_medium}')">
                <div class="info" onclick="playSong('${song.artist.name} ${song.title}', '${song.title}', '${song.artist.name}', '${song.album.cover_medium}')">
                    <h4>${song.title}</h4>
                    <p>${song.artist.name}</p>
                </div>
                <div class="fav-btn ${isFav ? 'active' : ''}" onclick="toggleFavorite(${songData}, this)">❤</div>
            </div>`;
        }).join('');
    }

    function toggleFavorite(song, el) {
        const index = favorites.findIndex(f => f.id === song.id);
        if (index > -1) favorites.splice(index, 1);
        else favorites.push(song);
        localStorage.setItem('myFavorites', JSON.stringify(favorites));
        el.classList.toggle('active');
    }

    function renderFavorites() {
        document.getElementById('artist-poster').style.display = 'none';
        document.getElementById('tab-explore').classList.remove('active');
        document.getElementById('tab-favs').classList.add('active');
        if(favorites.length === 0) {
            document.getElementById('list').innerHTML = "<p style='color:#888'>Henüz favorin yok.</p>";
            document.getElementById('viewTitle').innerText = "Favorilerim";
        } else {
            renderList(favorites, "Favorilerim");
        }
    }

    async function playSong(query, title, artist, img) {
        document.getElementById('current-title').innerText = "Aranıyor...";
        const yUrl = `https://www.googleapis.com/youtube/v3/search?part=snippet&q=${encodeURIComponent(query)}&key=${YT_API_KEY}&type=video&maxResults=1`;
        const yRes = await fetch(yUrl);
        const yData = await yRes.json();
        if(yData.items && yData.items[0]) {
            document.getElementById('current-img').src = img;
            document.getElementById('current-title').innerText = title;
            document.getElementById('current-artist').innerText = artist;
            player.loadVideoById(yData.items[0].id.videoId);
        }
    }

    window.onload = () => searchDeezer('popüler');
</script>
</body>
</html>
