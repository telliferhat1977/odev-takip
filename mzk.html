<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Müzik Dünyam - Akıllı Arama</title>
    <style>
        :root { --bg-color: #000; --accent: #1db954; --text: #fff; --card: rgba(255,255,255,0.1); }
        body { background: var(--bg-color); color: var(--text); font-family: -apple-system, sans-serif; margin: 0; padding-bottom: 180px; transition: background 1.2s ease; overflow-x: hidden; }
        .bg-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(180deg, transparent 0%, rgba(0,0,0,0.8) 100%); z-index: -1; }
        
        .header { padding: 15px 20px; position: sticky; top: 0; background: rgba(0,0,0,0.85); backdrop-filter: blur(25px); z-index: 1000; display: flex; gap: 10px; align-items: center; }
        #backBtn { background: none; border: none; color: var(--accent); font-weight: bold; font-size: 32px; cursor: pointer; display: none; }
        input { flex: 1; padding: 12px; border-radius: 12px; border: none; background: #222; color: #fff; outline: none; font-size: 16px; }
        .fav-btn { color: #ff2d55; font-size: 26px; cursor: pointer; padding-left: 10px; }

        .grid-container { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; padding: 15px; }
        .item-card { background: var(--card); border-radius: 15px; overflow: hidden; position: relative; transition: 0.3s; border: 1px solid rgba(255,255,255,0.05); }
        .item-card img { width: 100%; aspect-ratio: 1; object-fit: cover; display: block; }
        .item-card h4 { font-size: 13px; margin: 8px 8px 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .item-card p { font-size: 11px; margin: 0 8px 10px; color: #aaa; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        
        .list-container { padding: 15px; }
        .row-item { display: flex; align-items: center; padding: 12px; margin-bottom: 8px; background: var(--card); border-radius: 12px; }
        .row-item.active { border: 1px solid var(--accent); background: rgba(29,185,84,0.15); }
        .row-item img { width: 48px; height: 48px; border-radius: 6px; margin-right: 12px; }
        .song-meta { flex: 1; overflow: hidden; }
        .song-meta h4 { margin: 0; font-size: 14px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .song-meta p { margin: 2px 0 0; font-size: 12px; color: #888; }

        .footer-player { position: fixed; bottom: 0; width: 100%; background: rgba(15,15,15,0.98); backdrop-filter: blur(30px); border-top: 1px solid #333; z-index: 2000; padding: 10px 20px calc(25px + env(safe-area-inset-bottom)); box-sizing: border-box; }
        .prog-bg { width: 100%; height: 4px; background: #333; border-radius: 2px; margin-bottom: 15px; cursor: pointer; }
        #prog-bar { height: 100%; background: var(--accent); width: 0%; border-radius: 2px; }
        .player-controls { display: flex; align-items: center; justify-content: space-between; }
        .now-playing { display: flex; align-items: center; flex: 1; overflow: hidden; }
        .now-playing img { width: 50px; height: 50px; border-radius: 8px; margin-right: 12px; object-fit: cover; }
        .ctrl-btns { display: flex; align-items: center; gap: 18px; }
        .btn-icon { background: none; border: none; color: #fff; font-size: 28px; cursor: pointer; }
        .play-pause-circle { background: #fff; color: #000; width: 46px; height: 46px; border-radius: 50%; font-size: 20px; display: flex; align-items: center; justify-content: center; }
        #yt-player { display: none; }
    </style>
</head>
<body>

<div class="bg-overlay"></div>

<div class="header">
    <button id="backBtn" onclick="window.history.back()">‹</button>
    <input type="text" id="searchInput" placeholder="Şarkı, Sanatçı veya Albüm..." onkeyup="if(event.key==='Enter') executeSearch(this.value)">
    <div class="fav-btn" onclick="showFavorites()">♥</div>
</div>

<div id="mainContent">
    <h3 id="viewTitle" style="padding: 15px 20px 0; margin-bottom: 0;">Hitler</h3>
    <div id="displayArea" class="grid-container"></div>
</div>

<div class="footer-player">
    <div class="prog-bg" onclick="seek(event)">
        <div id="prog-bar"></div>
    </div>
    <div class="player-controls">
        <div class="now-playing">
            <img id="curr-img" src="https://via.placeholder.com/50">
            <div style="overflow: hidden;">
                <div id="curr-title" style="font-size: 13px; font-weight: bold; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">Müzik Dünyam</div>
                <div id="curr-artist" style="font-size: 11px; color: #aaa;">Bir seçim yapın</div>
            </div>
        </div>
        <div class="ctrl-btns">
            <button class="btn-icon" onclick="playPrev()">⏮</button>
            <button class="btn-icon play-pause-circle" onclick="togglePlay()" id="playBtn">▶</button>
            <button class="btn-icon" onclick="playNext()">⏭</button>
        </div>
    </div>
</div>

<div id="yt-player"></div>

<script src="https://www.youtube.com/iframe_api"></script>
<script>
    const YT_KEY = "AIzaSyAkWmhLagzkGE_tNUfg7W1jzeWnKdMv1rg";
    let player, progTimer;
    let queue = [];
    let qIndex = -1;
    let favorites = JSON.parse(localStorage.getItem('myMusicFavs')) || [];
    const currentYear = new Date().getFullYear();

    function onYouTubeIframeAPIReady() {
        player = new YT.Player('yt-player', {
            height: '0', width: '0',
            playerVars: { 'autoplay': 1, 'playsinline': 1 },
            events: { 
                'onStateChange': (e) => {
                    document.getElementById('playBtn').innerText = (e.data === 1) ? "⏸" : "▶";
                    if(e.data === 1) startProg(); else clearInterval(progTimer);
                    if(e.data === 0) playNext();
                }
            }
        });
    }

    window.onpopstate = function(e) {
        if (!e.state) loadInitial();
        else if (e.state.page === 'album') loadAlbumTracks(e.state.id, e.state.name, e.state.img, false);
        else if (e.state.page === 'search') executeSearch(e.state.query, false);
        else if (e.state.page === 'favs') showFavorites(false);
    };

    function startProg() {
        clearInterval(progTimer);
        progTimer = setInterval(() => {
            if (player && player.getDuration) {
                const p = (player.getCurrentTime() / player.getDuration()) * 100;
                document.getElementById('prog-bar').style.width = p + "%";
            }
        }, 1000);
    }

    function seek(e) {
        const rect = e.currentTarget.getBoundingClientRect();
        player.seekTo(((e.clientX - rect.left) / rect.width) * player.getDuration());
    }

    async function loadInitial() {
        document.getElementById('backBtn').style.display = 'none';
        document.getElementById('viewTitle').innerText = `${currentYear-1}-${currentYear} Türkiye Popüler`;
        const res = await fetch(`https://itunes.apple.com/search?term=Türkçe+Pop+Yeni&entity=album&limit=24&country=tr&lang=tr_tr`);
        const data = await res.json();
        renderAlbums(data.results);
    }

    // AKILLI HİBRİT ARAMA
    async function executeSearch(q, push = true) {
        if(push) history.pushState({page: 'search', query: q}, "");
        document.getElementById('viewTitle').innerText = `"${q}" için sonuçlar`;
        document.getElementById('backBtn').style.display = 'block';

        // Hem albüm hem şarkı içeren geniş kapsamlı arama (İçinde şarkı geçen albümleri de getirir)
        const res = await fetch(`https://itunes.apple.com/search?term=${encodeURIComponent(q)}&entity=album&limit=30&country=tr&lang=tr_tr`);
        const data = await res.json();
        
        if (data.results.length === 0) {
            // Eğer albüm olarak hiç sonuç çıkmazsa doğrudan şarkı olarak ara
            const resSong = await fetch(`https://itunes.apple.com/search?term=${encodeURIComponent(q)}&entity=song&limit=30&country=tr&lang=tr_tr`);
            const dataSong = await resSong.json();
            queue = dataSong.results.map(t => ({
                title: t.trackName, artist: t.artistName, img: t.artworkUrl100.replace('100x100','600x600')
            }));
            renderSongs(queue);
        } else {
            renderAlbums(data.results);
        }
    }

    function renderAlbums(albums) {
        const area = document.getElementById('displayArea');
        area.className = "grid-container";
        area.innerHTML = albums.map(a => `
            <div class="item-card" onclick="loadAlbumTracks(${a.collectionId}, '${a.collectionName.replace(/'/g,"")}', '${a.artworkUrl100.replace('100x100','600x600')}', true)">
                <img src="${a.artworkUrl100.replace('100x100','400x400')}">
                <h4>${a.collectionName}</h4>
                <p>${a.artistName}</p>
            </div>
        `).join('');
    }

    async function loadAlbumTracks(id, name, img, push) {
        if(push) history.pushState({page: 'album', id, name, img}, "");
        document.getElementById('backBtn').style.display = 'block';
        document.getElementById('viewTitle').innerText = name;
        
        const res = await fetch(`https://itunes.apple.com/lookup?id=${id}&entity=song&country=tr&lang=tr_tr`);
        const data = await res.json();
        queue = data.results.filter(r => r.wrapperType === 'track').map(t => ({
            title: t.trackName, artist: t.artistName, img: img
        }));
        renderSongs(queue);
    }

    function renderSongs(songs) {
        const area = document.getElementById('displayArea');
        area.className = "list-container";
        area.innerHTML = songs.map((s, i) => `
            <div class="row-item ${qIndex === i ? 'active' : ''}" onclick="playSong(${i})">
                <img src="${s.img}">
                <div class="song-meta">
                    <h4>${s.title}</h4>
                    <p>${s.artist}</p>
                </div>
                <div onclick="event.stopPropagation(); toggleFav(${i})" style="color:${isFav(s)?'#ff2d55':'#444'}; font-size:24px; cursor:pointer;">♥</div>
            </div>
        `).join('');
    }

    async function playSong(i) {
        qIndex = i;
        const s = queue[qIndex];
        document.getElementById('curr-title').innerText = "Yükleniyor...";
        const ytRes = await fetch(`https://www.googleapis.com/youtube/v3/search?part=snippet&q=${encodeURIComponent(s.artist+' '+s.title+' official audio')}&key=${YT_KEY}&type=video&maxResults=1`);
        const ytData = await ytRes.json();
        if(ytData.items && ytData.items[0]) {
            player.loadVideoById(ytData.items[0].id.videoId);
            document.getElementById('curr-img').src = s.img;
            document.getElementById('curr-title').innerText = s.title;
            document.getElementById('curr-artist').innerText = s.artist;
            renderSongs(queue);
            updateTheme(s.img);
        }
    }

    function playNext() { if(qIndex < queue.length - 1) playSong(qIndex + 1); }
    function playPrev() { if(qIndex > 0) playSong(qIndex - 1); }
    function togglePlay() { player.getPlayerState() === 1 ? player.pauseVideo() : player.playVideo(); }

    function toggleFav(i) {
        const s = queue[i];
        const idx = favorites.findIndex(f => f.title === s.title);
        if(idx > -1) favorites.splice(idx,1); else favorites.push(s);
        localStorage.setItem('myMusicFavs', JSON.stringify(favorites));
        renderSongs(queue);
    }
    function isFav(s) { return favorites.some(f => f.title === s.title); }

    function showFavorites(push = true) {
        if(push) history.pushState({page: 'favs'}, "");
        document.getElementById('viewTitle').innerText = "Favorilerim";
        document.getElementById('backBtn').style.display = 'block';
        queue = [...favorites];
        renderSongs(queue);
    }

    function updateTheme(url) {
        const img = new Image(); img.crossOrigin = "Anonymous"; img.src = url;
        img.onload = () => {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            canvas.width = 1; canvas.height = 1;
            ctx.drawImage(img, 0, 0, 1, 1);
            const d = ctx.getImageData(0,0,1,1).data;
            document.body.style.background = `rgb(${d[0]/7},${d[1]/7},${d[2]/7})`;
        }
    }

    window.onload = loadInitial;
</script>
</body>
</html>
