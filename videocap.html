<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SinemaTV PRO ‚Äì iPhone</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
:root{--red:#E50914;--black:#080808}
body{background:var(--black);color:#fff;margin:0;padding:10px;font-family:sans-serif;overflow:hidden}
.nav-item{cursor:pointer;border-radius:12px;transition:.15s}
.nav-item:focus{outline:none;background:var(--red);transform:scale(1.05)}
.full-modal{display:none!important;position:fixed;inset:0;background:rgba(0,0,0,.97);z-index:9999;overflow-y:auto;flex-direction:column}
.show-modal{display:flex!important}
#results{height:calc(100vh - 170px);overflow-y:auto}
iframe{border:none;width:100%;height:100%;flex:1}
#extIframeModal .close-btn{position:absolute;top:10px;right:10px;z-index:10;}
#extIframeModal .fullscreen-btn{position:absolute;top:10px;right:120px;z-index:10;padding:10px 20px;font-size:1.2rem;background:#E50914;color:white;border:none;border-radius:12px;cursor:pointer;}
#extIframeModal .fullscreen-btn:hover,
#extIframeModal .fullscreen-btn:focus{background:#c00a10;transform:scale(1.05);}
</style>
</head>
<body onload="loadShowcase()">
<header class="text-center mb-4">
<h1 class="text-3xl font-black italic text-red-600">SinemaTV PRO</h1>
<div class="flex gap-2 mt-3">
<input id="searchInput" placeholder="Film / Dizi / Oyuncu"
 class="flex-1 p-3 bg-[#1a1a1a] rounded-xl nav-item">
<button onclick="searchContent()"
 class="px-6 bg-red-600 rounded-xl font-bold nav-item">ARA</button>
</div>
</header>
<div id="results" class="grid grid-cols-3 sm:grid-cols-5 gap-4"></div>

<!-- DETAIL -->
<div id="detailPage" class="full-modal z-[1000] flex-col items-center p-6">
<button onclick="goBack()" class="mb-4 nav-item px-6 py-2 bg-white/10 rounded-full">‚Üê GERƒ∞</button>
<img id="detailPoster" class="max-h-[250px] rounded-xl mb-4">
<h2 id="detailTitle" class="text-2xl font-black mb-3"></h2>
<div id="castList" class="flex flex-wrap gap-2 mb-6"></div>
<button onclick="openSources()" class="bg-red-600 px-8 py-4 rounded-xl font-black nav-item">‚ñ∂ ƒ∞ZLE</button>
</div>

<!-- ACTOR -->
<div id="actorPage" class="full-modal z-[1200] flex-col items-center p-6">
<button onclick="goBack()" class="mb-4 nav-item px-6 py-2 bg-white/10 rounded-full">‚Üê GERƒ∞</button>
<img id="actorPhoto" class="w-32 h-32 rounded-full mb-3 object-cover">
<h2 id="actorName" class="text-xl font-black mb-2"></h2>
<p id="actorBio" class="text-xs text-gray-400 max-w-xl text-center mb-4"></p>
<div class="flex gap-2 mb-4">
<button onclick="setActorFilter('all')" class="nav-item px-4 py-1 bg-[#222] rounded-full">T√ºm√º</button>
<button onclick="setActorFilter('movie')" class="nav-item px-4 py-1 bg-[#222] rounded-full">Film</button>
<button onclick="setActorFilter('tv')" class="nav-item px-4 py-1 bg-[#222] rounded-full">Dizi</button>
</div>
<div id="actorFilmography" class="grid grid-cols-3 sm:grid-cols-5 gap-4"></div>
</div>

<!-- SELECTION -->
<div id="selectionModal" class="full-modal z-[1500] flex items-center justify-center">
<div class="bg-[#111] p-6 rounded-xl w-full max-w-md">
<h2 id="modalTitle" class="text-center font-black mb-4 text-red-600">MEN√ú</h2>
<div id="modalList" class="space-y-2"></div>
<button onclick="handleBack()" class="mt-4 w-full bg-gray-700 p-2 rounded nav-item">GERƒ∞</button>
</div>
</div>

<!-- PIN -->
<div id="pinModal" class="full-modal z-[2000] flex items-center justify-center">
<div class="bg-[#111] p-6 rounded-xl text-center">
<h2 class="font-black mb-3">PIN Gƒ∞R</h2>
<input id="pinInput" type="password" maxlength="4"
 class="text-center text-2xl bg-black border border-red-600 p-2 mb-4 w-32">
<div class="flex gap-2">
<button onclick="closePin()" class="flex-1 bg-gray-700 p-2 rounded">ƒ∞PTAL</button>
<button onclick="checkPin()" class="flex-1 bg-red-600 p-2 rounded">OK</button>
</div>
</div>
</div>

<!-- PLAYER -->
<div id="videoLayer" class="fixed inset-0 bg-black z-[3000] hidden flex-col relative">
<button onclick="goBack()" class="close-btn m-3 bg-white/10 px-6 py-2 rounded-full nav-item">‚Üê KAPAT</button>
<button onclick="togglePlayerFullscreen()" class="fullscreen-btn">TAM EKRAN</button>
<iframe id="playerFrame" class="flex-1 w-full" allowfullscreen></iframe>
</div>

<!-- HARƒ∞Cƒ∞ KAYNAKLAR IFRAME MODAL -->
<div id="extIframeModal" class="full-modal z-[4000] flex-col relative">
<button onclick="closeExtIframe()" class="close-btn nav-item px-6 py-2 bg-red-600 rounded-full text-white font-bold">KAPAT</button>
<button onclick="toggleFullscreen()" class="fullscreen-btn">TAM EKRAN</button>
<iframe id="extIframe" class="flex-1 w-full" sandbox="allow-scripts allow-same-origin allow-modals allow-popups allow-top-navigation-by-user-activation"></iframe>
</div>

<script>
const TMDB = "847629da5649502fa6655f73b15a5c8e";
const SAFE_PIN = "1234";
let currentId, currentType, currentS = 1, currentE = 1, imdbId;
let actorCredits = [], actorFilter = "all";
let menuStack = [];
let pageHistory = [];

// Sayfa y√ºklendiƒüinde ana ekranƒ± history'ye ekle
window.addEventListener('load', () => {
    pageHistory.push({ type: "main" });
});

async function loadShowcase() {
    const r = await fetch(`https://api.themoviedb.org/3/trending/all/day?api_key=${TMDB}&language=tr`);
    displayItems((await r.json()).results);
}

async function searchContent() {
    const q = searchInput.value.trim();
    if (!q) return loadShowcase();
    const r = await fetch(`https://api.themoviedb.org/3/search/multi?api_key=${TMDB}&query=${q}&language=tr`);
    displayItems((await r.json()).results);
}

function displayItems(items) {
    results.innerHTML = "";
    items.forEach(i => {
        if (i.media_type === "person") { openActor(i.id); return; }
        if (!i.poster_path) return;
        const type = i.media_type || (i.first_air_date ? "tv" : "movie");
        const b = document.createElement("button");
        b.className = "nav-item";
        b.innerHTML = `<img src="https://image.tmdb.org/t/p/w300${i.poster_path}" class="rounded-lg"><div class="text-[10px] font-bold truncate mt-1">${i.title || i.name}</div>`;
        b.onclick = () => openDetails(i.id, type);
        results.appendChild(b);
    });
}

async function openDetails(id, type) {
    currentId = id; currentType = type;
    const r = await fetch(`https://api.themoviedb.org/3/${type}/${id}?api_key=${TMDB}&language=tr&append_to_response=credits,external_ids`);
    const d = await r.json();
    imdbId = d.external_ids?.imdb_id || "";

    detailPoster.src = `https://image.tmdb.org/t/p/w500${d.poster_path || ""}`;
    detailTitle.innerText = d.title || d.name || "Ba≈ülƒ±k yok";

    castList.innerHTML = "";
    (d.credits?.cast || []).slice(0, 8).forEach(a => {
        const c = document.createElement("button");
        c.className = "nav-item bg-[#222] px-3 py-1 text-xs rounded-full";
        c.innerText = a.name;
        c.onclick = () => openActor(a.id);
        castList.appendChild(c);
    });

    pageHistory.push({ type: "detail", data: d });
    detailPage.classList.add("show-modal");
}

async function openActor(id) {
    detailPage.classList.remove("show-modal");
    const r = await fetch(`https://api.themoviedb.org/3/person/${id}?api_key=${TMDB}&language=tr&append_to_response=combined_credits`);
    const d = await r.json();

    actorName.innerText = d.name || "ƒ∞sim yok";
    actorBio.innerText = d.biography || "Biyografi yok.";
    actorPhoto.src = d.profile_path ? `https://image.tmdb.org/t/p/w300${d.profile_path}` : "";
    actorCredits = d.combined_credits?.cast || [];
    renderActor();

    pageHistory.push({ type: "actor", data: d });
    actorPage.classList.add("show-modal");
}

function renderActor() {
    actorFilmography.innerHTML = "";
    actorCredits.filter(i => i.poster_path && (actorFilter === "all" || i.media_type === actorFilter))
        .forEach(i => {
            const type = i.media_type === "tv" ? "tv" : "movie";
            const b = document.createElement("button");
            b.className = "nav-item";
            b.innerHTML = `<img src="https://image.tmdb.org/t/p/w300${i.poster_path}" class="rounded-lg"><div class="text-[10px] font-bold truncate mt-1">${i.title || i.name}</div>`;
            b.onclick = () => {
                actorPage.classList.remove("show-modal");
                setTimeout(() => openDetails(i.id, type), 100);
            };
            actorFilmography.appendChild(b);
        });
}

function setActorFilter(f) { actorFilter = f; renderActor(); }

function goBack() {
    if (videoLayer.style.display === "flex") {
        playerFrame.src = "";
        videoLayer.style.display = "none";
        return;
    }

    if (selectionModal.classList.contains("show-modal")) {
        handleBack();
        return;
    }

    if (extIframeModal.classList.contains("show-modal")) {
        closeExtIframe();
        return;
    }

    if (pageHistory.length <= 1) return;

    pageHistory.pop();

    detailPage.classList.remove("show-modal");
    actorPage.classList.remove("show-modal");

    const prev = pageHistory[pageHistory.length - 1];

    if (prev.type === "main") {
        // Ana ekran
    } else if (prev.type === "detail") {
        const d = prev.data;
        detailPoster.src = `https://image.tmdb.org/t/p/w500${d.poster_path || ""}`;
        detailTitle.innerText = d.title || d.name || "Ba≈ülƒ±k yok";

        castList.innerHTML = "";
        (d.credits?.cast || []).slice(0, 8).forEach(a => {
            const c = document.createElement("button");
            c.className = "nav-item bg-[#222] px-3 py-1 text-xs rounded-full";
            c.innerText = a.name;
            c.onclick = () => openActor(a.id);
            castList.appendChild(c);
        });

        detailPage.classList.add("show-modal");
    } else if (prev.type === "actor") {
        const d = prev.data;
        actorName.innerText = d.name || "ƒ∞sim yok";
        actorBio.innerText = d.biography || "Biyografi yok.";
        actorPhoto.src = d.profile_path ? `https://image.tmdb.org/t/p/w300${d.profile_path}` : "";
        actorCredits = d.combined_credits?.cast || [];
        renderActor();
        actorPage.classList.add("show-modal");
    }
}

/* SOURCES */
function openSources() {
    menuStack = [{ t: "KAYNAKLAR", i: [
        { n: "VIDSRC.ME (TR)", f: () => play("vidsrcme") },
        { n: "VIDLINK", f: () => play("vidlink") },
        { n: "VIDSRC.XYZ", f: () => play("vidsrc") },
        { n: "SUPEREMBED", f: () => play("super") },
        { n: "HARƒ∞Cƒ∞ KAYNAKLAR üîí", f: () => openPin() }
    ]}];
    renderMenu();
}

function renderMenu() {
    const m = menuStack.at(-1);
    modalTitle.innerText = m.t;
    modalList.innerHTML = "";
    m.i.forEach(x => {
        const b = document.createElement("button");
        b.className = "w-full bg-[#222] p-3 rounded nav-item";
        b.innerText = x.n;
        b.onclick = x.f;
        modalList.appendChild(b);
    });
    selectionModal.classList.add("show-modal");
}

function handleBack() {
    menuStack.pop();
    if (menuStack.length) renderMenu();
    else selectionModal.classList.remove("show-modal");
}

/* PIN + EXTERNAL */
function openPin() {
    selectionModal.classList.remove("show-modal");
    pinModal.classList.add("show-modal");
}

function closePin() {
    pinModal.classList.remove("show-modal");
}

function checkPin() {
    if (pinInput.value !== SAFE_PIN) { alert("Hatalƒ± PIN"); return; }
    pinModal.classList.remove("show-modal");
    openExternalMenu();
}

function openExternalMenu() {
    const q = encodeURIComponent(detailTitle.innerText.split("(")[0].trim());
    menuStack.push({ t: "HARƒ∞Cƒ∞ KAYNAKLAR", i: [
        { n: "EROGARGA", f: () => openExtIframe(`https://www.erogarga.com/?s=${q}`) },
        { n: "TUBE PORN CLASSIC", f: () => openExtIframe(`https://tubepornclassic.com/search/1/?s=${q}`) },
        { n: "XNXX", f: () => openExtIframe(`https://www.xnxx.com/search/${q.replace(/%20/g,'+')}`) },
        { n: "XVIDEOS", f: () => openExtIframe(`https://www.xvideos.com/?k=${q.replace(/%20/g,'+')}`) },
        { n: "NOODLEMAGAZINE", f: () => openExtIframe(`https://noodlemagazine.com/video/${q}`) }
    ]});
    renderMenu();
}

function openExtIframe(url) {
    // Kaynak men√ºs√ºn√º kapat (√∂nemli!)
    selectionModal.classList.remove("show-modal");

    extIframe.src = url;
    extIframeModal.classList.add("show-modal");

    extIframe.onload = function() {
        try {
            const doc = extIframe.contentDocument || extIframe.contentWindow.document;
            const videos = doc.querySelectorAll('video, source');
            let found = false;

            videos.forEach(v => {
                const src = v.src || v.currentSrc || v.getAttribute('src');
                if (src && (src.endsWith('.mp4') || src.endsWith('.m3u8') || src.includes('blob:') || src.includes('video'))) {
                    console.log("Yakalanan video linki:", src);
                    playerFrame.src = src;
                    videoLayer.style.display = "flex";
                    extIframeModal.classList.remove("show-modal");
                    alert("Video otomatik algƒ±landƒ± ve oynatƒ±lƒ±yor!");
                    found = true;
                }
            });

            if (!found) {
                console.log("Video linki bulunamadƒ± veya CORS engellendi.");
            }
        } catch (e) {
            console.log("Iframe eri≈üim hatasƒ± (muhtemelen CORS):", e);
        }
    };
}

function closeExtIframe() {
    extIframe.src = "";
    extIframeModal.classList.remove("show-modal");
}

function toggleFullscreen() {
    const iframe = document.getElementById('extIframe');
    if (!document.fullscreenElement) {
        if (iframe.requestFullscreen) {
            iframe.requestFullscreen();
        } else if (iframe.webkitRequestFullscreen) {
            iframe.webkitRequestFullscreen(Element.ALLOW_KEYBOARD_INPUT);
        } else if (iframe.msRequestFullscreen) {
            iframe.msRequestFullscreen();
        }
        document.querySelector('#extIframeModal .fullscreen-btn').innerText = "TAM EKRANDAN √áIK";
    } else {
        if (document.exitFullscreen) {
            document.exitFullscreen();
        } else if (document.webkitExitFullscreen) {
            document.webkitExitFullscreen();
        } else if (document.msExitFullscreen) {
            document.msExitFullscreen();
        }
        document.querySelector('#extIframeModal .fullscreen-btn').innerText = "TAM EKRAN";
    }
}

function togglePlayerFullscreen() {
    const iframe = document.getElementById('playerFrame');
    if (!document.fullscreenElement) {
        if (iframe.requestFullscreen) {
            iframe.requestFullscreen();
        } else if (iframe.webkitRequestFullscreen) {
            iframe.webkitRequestFullscreen(Element.ALLOW_KEYBOARD_INPUT);
        } else if (iframe.msRequestFullscreen) {
            iframe.msRequestFullscreen();
        }
        document.querySelector('#videoLayer .fullscreen-btn').innerText = "TAM EKRANDAN √áIK";
    } else {
        if (document.exitFullscreen) {
            document.exitFullscreen();
        } else if (document.webkitExitFullscreen) {
            document.webkitExitFullscreen();
        } else if (document.msExitFullscreen) {
            document.msExitFullscreen();
        }
        document.querySelector('#videoLayer .fullscreen-btn').innerText = "TAM EKRAN";
    }
}

/* PLAYER */
function play(src) {
    let url = "";
    if (src === "vidsrcme") url = currentType === "tv"
        ? `https://vidsrc.me/embed/tv?tmdb=${currentId}&sea=${currentS}&epi=${currentE}&ds_lang=tr`
        : `https://vidsrc.me/embed/movie?tmdb=${currentId}&ds_lang=tr`;
    if (src === "vidlink") url = `https://vidlink.pro/movie/${currentId}?subs=tr`;
    if (src === "vidsrc") url = `https://vidsrc.xyz/embed/movie?imdb=${imdbId}`;
    if (src === "super") url = `https://multiembed.mov/directstream.php?video_id=${currentId}&tmdb=1`;

    playerFrame.src = url;
    videoLayer.style.display = "flex";

    playerFrame.onload = function() {
        try {
            const doc = playerFrame.contentDocument || playerFrame.contentWindow.document;
            const videos = doc.querySelectorAll('video, source');
            let found = false;

            videos.forEach(v => {
                const src = v.src || v.currentSrc || v.getAttribute('src');
                if (src && (src.endsWith('.mp4') || src.endsWith('.m3u8') || src.includes('blob:') || src.includes('video'))) {
                    console.log("Normal kaynakta yakalanan video:", src);
                    playerFrame.src = src;
                    found = true;
                }
            });

            if (!found) {
                console.log("Normal kaynakta video linki yakalanamadƒ±.");
            }
        } catch (e) {
            console.log("Normal kaynak iframe eri≈üim hatasƒ±:", e);
        }
    };
}
</script>
</body>
</html>