<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SinemaTV Pro v16 - Mi Box Ultimate</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root { --n-red: #E50914; --n-black: #141414; }
        body { background-color: var(--n-black); color: white; font-family: sans-serif; margin: 0; overflow-x: hidden; padding: 15px; }
        .nav-item { transition: all 0.2s; cursor: pointer; border: 3px solid transparent; outline: none; }
        .nav-item:focus { border-color: white !important; background-color: var(--n-red) !important; transform: scale(1.05); }
        .full-modal { display: none !important; position: fixed; inset: 0; background: rgba(10,10,10,0.99); z-index: 1000; overflow-y: auto; padding: 20px; }
        .show-modal { display: flex !important; flex-direction: column; align-items: center; }
        .show-block { display: block !important; }
        .video-layer { display: none; position: fixed; inset: 0; background: black; z-index: 2000; flex-direction: column; }
        .source-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; width: 100%; }
        .source-btn { background: #222; padding: 15px; border-radius: 12px; font-weight: bold; font-size: 14px; text-align: center; width: 100%; }
        .badge { font-size: 9px; font-weight: 900; padding: 2px 6px; border-radius: 4px; margin-top: 5px; display: inline-block; text-transform: uppercase; }
        #detailPoster { max-height: 180px; width: auto; border-radius: 15px; margin-bottom: 10px; border: 2px solid rgba(255,255,255,0.1); }
        #detailOverview { display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden; font-size: 12px; }
    </style>
</head>
<body>

    <div id="mainUI">
        <header class="flex flex-col items-center mb-6">
            <h1 class="text-3xl font-black text-[#E50914] tracking-tighter uppercase italic mb-4">Sinema<span class="text-white">TV Pro</span></h1>
            <div class="flex w-full gap-2">
                <input type="text" id="searchInput" placeholder="Film, Dizi veya Oyuncu..." class="nav-item bg-[#222] p-4 flex-1 rounded-xl outline-none text-sm">
                <button onclick="searchContent()" class="nav-item bg-[#E50914] px-6 py-4 rounded-xl font-bold uppercase text-xs">Ara</button>
            </div>
        </header>
        <div id="results" class="grid grid-cols-2 sm:grid-cols-4 gap-4"></div>
    </div>

    <div id="detailPage" class="full-modal">
        <div class="w-full max-w-4xl text-center">
            <button onclick="closeDetail()" class="nav-item mb-4 bg-white/10 px-6 py-2 rounded-full font-bold text-xs">← GERİ</button>
            <div class="flex flex-col items-center">
                <img id="detailPoster" src="">
                <h2 id="detailTitle" class="text-2xl font-black mb-1"></h2>
                <div class="flex gap-4 mb-2 text-xs text-yellow-500 font-bold"><span id="detailRating"></span><span id="detailYear" class="text-gray-400"></span></div>
                <p id="detailOverview" class="text-gray-400 px-4 italic"></p>
                <div id="detailCast" class="flex flex-wrap justify-center gap-2 mb-6 px-4"></div>
                <button id="playBtn" onclick="checkTypeAndPlay()" class="nav-item bg-[#E50914] w-full py-5 rounded-2xl font-black text-xl">▶ ŞİMDİ İZLE</button>
            </div>
        </div>
    </div>

    <div id="episodeModal" class="full-modal"><div class="bg-[#1a1a1a] w-full max-w-xl p-6 rounded-3xl text-center"><h2 class="text-xl font-black mb-6 text-red-500 uppercase italic">Bölüm Seç</h2><div id="episodeList" class="max-h-[50vh] overflow-y-auto space-y-2 pr-2"></div><button onclick="closeModal('episodeModal')" class="nav-item mt-6 w-full p-4 bg-gray-800 rounded-xl font-bold uppercase text-xs">Vazgeç</button></div></div>
    <div id="sourceModal" class="full-modal"><div class="bg-[#1a1a1a] p-8 rounded-3xl border border-gray-700 w-full max-w-md text-center"><h2 class="text-xl font-black mb-2 uppercase italic text-red-600">KAYNAK SEÇ</h2><div id="sourceButtons" class="source-grid"></div><button onclick="closeModal('sourceModal')" class="nav-item mt-6 w-full p-4 bg-gray-800 rounded-xl font-bold uppercase text-xs">← VAZGEÇ</button></div></div>

    <div id="videoLayer" class="video-layer">
        <div class="p-3 bg-black flex justify-between items-center"><button onclick="closePlayerToSources()" class="nav-item bg-white/10 px-6 py-2 rounded-full font-bold text-xs uppercase">← KAYNAKLARA DÖN</button></div>
        <iframe id="playerFrame" src="" class="flex-1 w-full border-none" allowfullscreen allow="autoplay"></iframe>
    </div>

    <script>
        const API_KEY = "847629da5649502fa6655f73b15a5c8e";
        let currentId, currentType, currentS, currentE;

        // FİZİKSEL GERİ TUŞU TAMİRİ
        window.addEventListener('popstate', function(event) {
            if (document.getElementById('videoLayer').style.display === 'flex') {
                closePlayerToSources();
            } else if (document.getElementById('sourceModal').classList.contains('show-modal')) {
                closeModal('sourceModal');
            } else if (document.getElementById('episodeModal').classList.contains('show-modal')) {
                closeModal('episodeModal');
            } else if (document.getElementById('detailPage').classList.contains('show-block')) {
                closeDetail();
            }
        });

        function pushState() { history.pushState({page: 1}, null, ""); }

        async function searchContent() {
            const q = document.getElementById('searchInput').value;
            if(!q) return;
            const res = await fetch(`https://api.themoviedb.org/3/search/multi?api_key=${API_KEY}&query=${encodeURIComponent(q)}&language=tr-TR`);
            const data = await res.json();
            const actor = data.results.find(item => item.media_type === 'person');
            actor ? loadActorWorks(actor.id, actor.name) : displayItems(data.results);
        }

        async function loadActorWorks(id, name) {
            const res = await fetch(`https://api.themoviedb.org/3/person/${id}/combined_credits?api_key=${API_KEY}&language=tr-TR`);
            const data = await res.json();
            displayItems(data.cast.sort((a,b) => b.vote_count - a.vote_count));
            document.getElementById('searchInput').value = name;
            closeDetail();
        }

        function displayItems(items) {
            const container = document.getElementById('results'); container.innerHTML = "";
            items.forEach(item => {
                if(!item.poster_path) return;
                const type = item.media_type || (item.first_air_date ? 'tv' : 'movie');
                const label = type === 'movie' ? 'FİLM' : 'DİZİ';
                const color = type === 'movie' ? 'bg-blue-600/30 text-blue-400' : 'bg-red-600/30 text-red-400';
                const btn = document.createElement('button');
                btn.className = "nav-item rounded-xl overflow-hidden bg-[#1a1a1a] text-left";
                btn.innerHTML = `<img src="https://image.tmdb.org/t/p/w300${item.poster_path}" class="w-full aspect-[2/3] object-cover"><div class="p-2"><div class="text-[10px] font-bold truncate">${item.title || item.name}</div><span class="badge ${color}">${label}</span></div>`;
                btn.onclick = () => openDetails(item.id, type);
                container.appendChild(btn);
            });
        }

        async function openDetails(id, type) {
            pushState();
            currentId = id; currentType = type;
            const res = await fetch(`https://api.themoviedb.org/3/${type}/${id}?api_key=${API_KEY}&language=tr-TR&append_to_response=credits`);
            const data = await res.json();
            document.getElementById('detailTitle').innerText = data.title || data.name;
            document.getElementById('detailOverview').innerText = data.overview || "";
            document.getElementById('detailRating').innerText = "⭐ " + (data.vote_average ? data.vote_average.toFixed(1) : "0.0");
            document.getElementById('detailYear').innerText = (data.release_date || data.first_air_date || "").split('-')[0];
            document.getElementById('detailPoster').src = `https://image.tmdb.org/t/p/w500${data.poster_path}`;
            const cast = document.getElementById('detailCast'); cast.innerHTML = "";
            data.credits.cast.slice(0, 5).forEach(a => {
                const b = document.createElement('button'); b.className = "nav-item bg-[#333] px-3 py-1 rounded-lg text-[10px] font-bold";
                b.innerText = a.name; b.onclick = (e) => { e.stopPropagation(); loadActorWorks(a.id, a.name); };
                cast.appendChild(b);
            });
            document.getElementById('detailPage').classList.add('show-block');
        }

        async function checkTypeAndPlay() {
            pushState();
            if(currentType === 'tv') {
                const res = await fetch(`https://api.themoviedb.org/3/tv/${currentId}?api_key=${API_KEY}&language=tr-TR`);
                const data = await res.json();
                const list = document.getElementById('episodeList'); list.innerHTML = "";
                data.seasons.forEach(s => {
                    if(s.season_number === 0) return;
                    const b = document.createElement('button'); b.className = "nav-item source-btn";
                    b.innerHTML = `${s.name} <span class="text-red-500 ml-2">${s.episode_count} Bölüm</span>`;
                    b.onclick = async () => {
                        const epRes = await fetch(`https://api.themoviedb.org/3/tv/${currentId}/season/${s.season_number}?api_key=${API_KEY}&language=tr-TR`);
                        const epData = await epRes.json();
                        list.innerHTML = "";
                        epData.episodes.forEach(ep => {
                            const eb = document.createElement('button'); eb.className = "nav-item source-btn";
                            eb.innerText = `Bölüm ${ep.episode_number}: ${ep.name}`;
                            eb.onclick = () => { currentS = s.season_number; currentE = ep.episode_number; closeModal('episodeModal'); openSourceSelection(); };
                            list.appendChild(eb);
                        });
                    };
                    list.appendChild(b);
                });
                document.getElementById('episodeModal').classList.add('show-modal');
            } else { openSourceSelection(); }
        }

        function openSourceSelection() {
            pushState();
            const container = document.getElementById('sourceButtons'); container.innerHTML = "";
            const srcs = [{id:'vidlink',n:'VidLink'},{id:'vidsrc_to',n:'VidSrc.to'},{id:'vidsrc_me',n:'VidSrc.me'},{id:'superembed',n:'SuperEmbed'}];
            srcs.forEach(src => {
                const b = document.createElement('button'); b.className = "nav-item source-btn"; b.innerText = src.n;
                b.onclick = () => runFinalPlay(src.id);
                container.appendChild(b);
            });
            document.getElementById('sourceModal').classList.add('show-modal');
        }

        function runFinalPlay(provider) {
            pushState();
            const isTV = currentType === 'tv';
            const base = {
                vidlink: isTV ? `https://vidlink.pro/tv/${currentId}/${currentS}/${currentE}?subs=tr` : `https://vidlink.pro/movie/${currentId}?subs=tr`,
                vidsrc_to: isTV ? `https://vidsrc.to/embed/tv/${currentId}/${currentS}/${currentE}` : `https://vidsrc.to/embed/movie/${currentId}`,
                vidsrc_me: isTV ? `https://vidsrc.me/embed/tv?tmdb=${currentId}&sea=${currentS}&epi=${currentE}` : `https://vidsrc.me/embed/movie?tmdb=${currentId}`,
                superembed: isTV ? `https://multiembed.mov/directstream.php?video_id=${currentId}&tmdb=1&s=${currentS}&e=${currentE}` : `https://multiembed.mov/directstream.php?video_id=${currentId}&tmdb=1`
            };
            document.getElementById('playerFrame').src = base[provider];
            document.getElementById('videoLayer').style.display = 'flex';
        }

        function closePlayerToSources() { document.getElementById('playerFrame').src = ""; document.getElementById('videoLayer').style.display = 'none'; }
        function closeModal(id) { document.getElementById(id).classList.remove('show-modal'); }
        function closeDetail() { document.getElementById('detailPage').classList.remove('show-block'); }
        document.getElementById("searchInput").addEventListener("keypress",(e)=>{if(e.key==="Enter")searchContent();});
    </script>
</body>
</html>
