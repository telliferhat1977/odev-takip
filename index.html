<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Mobil Ödev Takip</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
<style>
body{font-family:Arial,sans-serif;background:#f4f6f8;margin:0;padding:10px;}
h1,h2{text-align:center;margin:5px 0;}
.section{background:#fff;padding:12px;margin-bottom:12px;border-radius:12px;box-shadow:0 3px 6px rgba(0,0,0,.1);}
input,select,button{width:100%;padding:14px;margin-top:6px;margin-bottom:12px;font-size:1.1rem;border-radius:10px;border:1px solid #ccc;}
button{border:none;border-radius:10px;background:#3498db;color:#fff;cursor:pointer;font-size:1.1rem;}
button.secondary{background:#7f8c8d;}
button.danger{background:#e74c3c;}
.ogrenci{background:#ecf0f1;padding:10px;border-radius:10px;margin-bottom:8px;}
.row{display:flex;gap:8px;margin-top:8px;flex-wrap:wrap;}
.row button{flex:1;min-width:45%;}
.gecmis{font-size:0.9rem;margin-top:6px;}
select[multiple]{height:120px;}
</style>
</head>
<body>

<div id="ilkEkran" class="section">
<h2>Okul Adı ve Öğretmen Adı Giriniz / Düzenleyiniz</h2>
<input id="okul" placeholder="Okul Adı">
<input id="ogretmen" placeholder="Öğretmen Adı">
<button id="kaydetOkulBtn">Kaydet / Güncelle</button>
</div>

<div id="mainApp" style="display:none;">
<h1 id="baslikOkul"></h1>
<h2 id="baslikOgretmen"></h2>

<div class="section">
<h2>Öğrenci Yönetimi</h2>
<input id="ad" placeholder="Ad Soyad">
<input id="no" placeholder="Numara">
<input id="sinif" placeholder="Sınıf">
<button id="kaydetBtn" type="button">Kaydet</button>
<button id="iptalBtn" type="button" class="secondary">İptal</button>
<hr>
<input id="arama" placeholder="Öğrenci adı veya no ile ara">
<div id="aramaSonuc" style="max-height:200px;overflow-y:auto;"></div>
</div>

<div class="section">
<h2>Ödev Kontrol</h2>
<input type="date" id="odevTarih">
<select id="odevSinif"></select>
<select id="odevOgrenciSec" size="6"></select>
<div id="odevIslem"></div>
</div>

<div class="section">
<h2>Ödev Geçmişi</h2>
<select id="gecmisSinif">
<option value="">Tüm Sınıflar</option>
</select>
<input type="date" id="gecmisTarih">
<select id="gecmisOgrenci"></select>
<div id="gecmisListe" style="max-height:200px;overflow-y:auto;"></div>
</div>

<div class="section">
<h2>PDF Rapor</h2>
<label>Günlük Rapor</label>
<input type="date" id="gunlukPdfTarih">
<button onclick="gunlukPdf()">Günlük PDF (Sınıf Bazlı)</button>
<hr>
<label>Aylık Rapor</label>
<input type="month" id="raporAy">
<button onclick="aylikPdf()">Aylık PDF (Sınıf Bazlı, Tablo)</button>
</div>

<div class="section">
<h2>Yedekleme</h2>
<button onclick="jsonYedekAl()">JSON Yedek Al</button>
<input type="file" id="jsonFile" accept="application/json">
<button class="secondary" onclick="jsonYukle()">Yedekten Yükle</button>
</div>

<script>
// --- Veri ---
let ogrenciler = JSON.parse(localStorage.getItem('ogrenciler')) || [];
let odevler = JSON.parse(localStorage.getItem('odevler')) || [];
let seciliNo = null;
let okulAd = localStorage.getItem('okulAd') || '';
let ogretmenAd = localStorage.getItem('ogretmenAd') || '';

// --- Elemanlar ---
const ilkEkran = document.getElementById('ilkEkran');
const mainApp = document.getElementById('mainApp');
const baslikOkul = document.getElementById('baslikOkul');
const baslikOgretmen = document.getElementById('baslikOgretmen');

const adInp = document.getElementById('ad');
const noInp = document.getElementById('no');
const sinifInp = document.getElementById('sinif');
const kaydetBtn = document.getElementById('kaydetBtn');
const iptalBtn = document.getElementById('iptalBtn');
const aramaInp = document.getElementById('arama');
const sonucDiv = document.getElementById('aramaSonuc');

const odevSinif = document.getElementById('odevSinif');
const odevOgrenciSec = document.getElementById('odevOgrenciSec');
const odevTarih = document.getElementById('odevTarih');

const gecmisSinif = document.getElementById('gecmisSinif');
const gecmisTarih = document.getElementById('gecmisTarih');
const gecmisOgrenci = document.getElementById('gecmisOgrenci');
const gecmisListe = document.getElementById('gecmisListe');

// --- Tarih ayarları ---
odevTarih.max = new Date().toISOString().split('T')[0];
odevTarih.value = new Date().toISOString().split('T')[0];

// --- Okul ve öğretmen kaydı ---
function gosterMainApp(){
    baslikOkul.textContent = okulAd;
    baslikOgretmen.textContent = ogretmenAd;
    document.getElementById('okul').value = okulAd;
    document.getElementById('ogretmen').value = ogretmenAd;
    ilkEkran.style.display = 'none';
    mainApp.style.display = 'block';
}
if(okulAd && ogretmenAd) gosterMainApp();

document.getElementById('kaydetOkulBtn').onclick=()=>{
    const o = document.getElementById('okul').value.trim();
    const g = document.getElementById('ogretmen').value.trim();
    if(!o||!g){alert('Okul ve öğretmen adı girin'); return;}
    okulAd=o; ogretmenAd=g;
    localStorage.setItem('okulAd',okulAd);
    localStorage.setItem('ogretmenAd',ogretmenAd);
    gosterMainApp();
};

// --- Öğrenci işlemleri ---
function kaydet(){
 const ad = adInp.value.trim();
 const no = noInp.value.trim();
 const sinif = sinifInp.value.trim();
 if(!ad||!no||!sinif){alert('Tüm alanları doldurun');return;}
 if(seciliNo){
  const o = ogrenciler.find(x=>x.no===seciliNo);
  o.ad=ad; o.no=no; o.sinif=sinif;
  seciliNo=null; kaydetBtn.textContent='Kaydet';
 } else {
  if(ogrenciler.some(x=>x.no===no)){alert('Numara zaten var');return;}
  ogrenciler.push({ad,no,sinif});
 }
 localStorage.setItem('ogrenciler',JSON.stringify(ogrenciler));
 temizle(); siniflariDoldur(); ogrenciDropdown(); alert('Kaydedildi');
}

function temizle(){adInp.value=noInp.value=sinifInp.value='';}
function iptal(){temizle();seciliNo=null;kaydetBtn.textContent='Kaydet';}

function arama(){
 const q = aramaInp.value.toLowerCase(); sonucDiv.innerHTML='';
 if(!q) return;
 ogrenciler.filter(o=>o.ad.toLowerCase().includes(q)||o.no.includes(q)).forEach(o=>{
  const d=document.createElement('div'); d.className='ogrenci';
  d.innerHTML=`<b>${o.ad}</b><br>No:${o.no} | ${o.sinif}
  <div class='row'>
   <button onclick="duzenle('${o.no}')">Güncelle</button>
   <button class='danger' onclick="sil('${o.no}')">Sil</button>
  </div>`;
  sonucDiv.appendChild(d);
 });
}

function duzenle(no){
 const o=ogrenciler.find(x=>x.no===no);
 adInp.value=o.ad; noInp.value=o.no; sinifInp.value=o.sinif;
 seciliNo=no; kaydetBtn.textContent='Güncelle';
}

function sil(no){
 if(!confirm('Silinsin mi?')) return;
 ogrenciler=ogrenciler.filter(x=>x.no!==no);
 odevler=odevler.filter(x=>x.no!==no);
 localStorage.setItem('ogrenciler',JSON.stringify(ogrenciler));
 localStorage.setItem('odevler',JSON.stringify(odevler));
 siniflariDoldur(); ogrenciDropdown(); sonucDiv.innerHTML='';
}

// --- Sınıflar ---
function siniflariDoldur(){
 odevSinif.innerHTML='<option value="">Sınıf Seç</option>';
 gecmisSinif.innerHTML='<option value="">Tüm Sınıflar</option>';
 const siniflar=[...new Set(ogrenciler.map(o=>o.sinif.trim().toUpperCase()))];
 siniflar.forEach(s=>{
   const opt=document.createElement('option');opt.value=s;opt.textContent=s;odevSinif.appendChild(opt);
   const opt2=document.createElement('option');opt2.value=s;opt2.textContent=s;gecmisSinif.appendChild(opt2);
 });
}

// --- Ödev kontrol ---
odevSinif.onchange=()=>{
 odevOgrenciSec.innerHTML='';
 ogrenciler.filter(o=>o.sinif.toUpperCase()===odevSinif.value)
 .forEach(o=>{
    const opt=document.createElement('option');
    opt.value=o.no;
    opt.textContent=`${o.ad} (${o.no})`;
    odevOgrenciSec.appendChild(opt);
 });
};

odevOgrenciSec.onchange=()=>{
 const no=odevOgrenciSec.value;
 const div=document.getElementById('odevIslem');
 div.innerHTML=`<button onclick="odevKaydet('${no}','yaptı')">Yaptı</button>
                <button onclick="odevKaydet('${no}','yapmadı')" class='danger'>Yapmadı</button>
                <button onclick="odevKaydet('${no}','gelmedi')" class='secondary'>Gelmedi</button>`;
};

function odevKaydet(no,durum){
 const tarih=odevTarih.value;
 const i=odevler.findIndex(o=>o.no===no&&o.tarih===tarih);
 if(i>-1) odevler[i].durum=durum; else odevler.push({no,tarih,durum});
 localStorage.setItem('odevler',JSON.stringify(odevler)); alert('Kaydedildi');
}

// --- Geçmiş ---
function ogrenciDropdown(){
 gecmisOgrenci.innerHTML='<option value="">Öğrenci Seç</option>';
 ogrenciler.forEach(o=>{
   const opt=document.createElement('option');
   opt.value=`${o.no}`;
   opt.textContent=`${o.ad} (${o.no})`;
   gecmisOgrenci.appendChild(opt);
 });
}

gecmisOgrenci.onchange=()=>{gecmisListeGoster();}
gecmisSinif.onchange=()=>{gecmisListeGoster();}
gecmisTarih.onchange=()=>{gecmisListeGoster();}

function gecmisListeGoster(){
 gecmisListe.innerHTML='';
 let seciliS = gecmisSinif.value;
 let seciliO = gecmisOgrenci.value;
 let seciliT = gecmisTarih.value;
 let list = odevler;
 if(seciliS) list = list.filter(o=>{
     const ogr = ogrenciler.find(x=>x.no===o.no);
     return ogr && ogr.sinif.toUpperCase()===seciliS;
 });
 if(seciliO) list = list.filter(o=>o.no===seciliO);
 if(seciliT) list = list.filter(o=>o.tarih===seciliT);
 list.forEach(o=>{
   const ogr=ogrenciler.find(x=>x.no===o.no); if(!ogr) return;
   const d=document.createElement('div');d.className='ogrenci gecmis';
   d.textContent=`${ogr.ad} (${ogr.no}) | ${o.tarih} → ${o.durum}`;
   gecmisListe.appendChild(d);
 });
}

// --- PDF Günlük ---
async function gunlukPdf(){
 const tarih = document.getElementById('gunlukPdfTarih').value;
 if(!tarih){alert('Tarih seçin'); return;}
 const { jsPDF } = window.jspdf;
 const doc = new jsPDF();
 let sinifSet = [...new Set(odevler.filter(o=>o.tarih===tarih).map(o=>{
   const ogr=ogrenciler.find(x=>x.no===o.no); return ogr?ogr.sinif:'';
 }).filter(Boolean))];
 sinifSet.forEach((s,index)=>{
   if(index>0) doc.addPage();
   const data = odevler.filter(o=>o.tarih===tarih).map(o=>{
       const ogr=ogrenciler.find(x=>x.no===o.no);
       if(!ogr || ogr.sinif.toUpperCase()!==s) return null;
       return [ogr.no, ogr.ad, o.durum];
   }).filter(Boolean);
   doc.setFont("helvetica");
   doc.setFontSize(16);
   doc.text(`${s} - Günlük Ödev Raporu`,14,14);
   doc.setFontSize(12);
   doc.text(`${okulAd} | ${ogretmenAd}`,14,22);
   doc.autoTable({head:[['Numara','Ad Soyad','Durum']], body:data, startY:28, styles:{font:'helvetica'}, headStyles:{fillColor:[52,152,219],textColor:255}});
 });
 doc.save(`gunluk_${tarih}.pdf`);
}

// --- PDF Aylık (Tablo) ---
async function aylikPdf(){
 const ay=document.getElementById('raporAy').value;
 if(!ay){alert('Ay seçin'); return;}
 const { jsPDF } = window.jspdf;
 const doc = new jsPDF();
 let sinifSet = [...new Set(odevler.filter(o=>o.tarih.startsWith(ay)).map(o=>{
   const ogr=ogrenciler.find(x=>x.no===o.no); return ogr?ogr.sinif:'';
 }).filter(Boolean))];
 sinifSet.forEach((s,index)=>{
   if(index>0) doc.addPage();
   const tarihler = [...new Set(odevler.filter(o=>o.tarih.startsWith(ay)).map(x=>x.tarih))].sort();
   let body = [];
   ogrenciler.filter(o=>o.sinif.toUpperCase()===s).forEach(ogr=>{
       let row = [ogr.no, ogr.ad];
       tarihler.forEach(t=>{
           const d = odevler.find(x=>x.no===ogr.no && x.tarih===t);
           row.push(d?d.durum:'-');
       });
       body.push(row);
   });
   let head = ['Numara','Ad Soyad',...tarihler];
   doc.setFont("helvetica");
   doc.setFontSize(16);
   doc.text(`${s} - Aylık Ödev Raporu`,14,14);
   doc.setFontSize(12);
   doc.text(`${okulAd} | ${ogretmenAd}`,14,22);
   doc.autoTable({head:[head], body:body, startY:28, styles:{font:'helvetica'}, headStyles:{fillColor:[52,152,219], textColor:255}});
 });
 doc.save(`aylik_${ay}.pdf`);
}

// --- JSON Yedekleme ---
function jsonYedekAl(){
 const blob=new Blob([JSON.stringify({ogrenciler,odevler},null,2)],{type:'application/json'});
 const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download='odev_yedek.json';a.click();
}

function jsonYukle(){
 const f=document.getElementById('jsonFile').files[0]; if(!f) return;
 const r=new FileReader(); r.onload=e=>{
  const d=JSON.parse(e.target.result);
  d.ogrenciler.forEach(o=>{if(!ogrenciler.some(x=>x.no===o.no)) ogrenciler.push(o);});
  d.odevler.forEach(o=>{if(!odevler.some(x=>x.no===o.no&&x.tarih===o.tarih)) odevler.push(o);});
  localStorage.setItem('ogrenciler',JSON.stringify(ogrenciler));
  localStorage.setItem('odevler',JSON.stringify(odevler));
  siniflariDoldur(); ogrenciDropdown(); alert('Yüklendi');
 };
 r.readAsText(f);
}

// --- Event listeners ---
kaydetBtn.addEventListener('click',kaydet);
iptalBtn.addEventListener('click',iptal);
aramaInp.addEventListener('input',arama);
siniflariDoldur(); ogrenciDropdown();

</script>
</body>
</html>
