<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ã–dev Takip</title>

    <!-- iOS PWA ayarlarÄ± -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Ã–dev Takip">
    <meta name="theme-color" content="#3498db">

    <style>
        body {
            font-family: Arial, sans-serif;
            background: #f4f6f8;
            margin: 0;
            padding: 10px;
        }
        h1, h2 { text-align: center; }
        .section {
            background: #ffffff;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 12px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
        }
        label { font-weight: bold; }
        input, select, button {
            width: 100%;
            padding: 14px;
            margin-top: 6px;
            margin-bottom: 12px;
            font-size: 1rem;
        }
        button {
            border: none;
            border-radius: 10px;
            background: #3498db;
            color: #fff;
        }
        button.secondary { background: #7f8c8d; }
        button.danger { background: #e74c3c; }

        .ogrenci-item {
            background: #ecf0f1;
            padding: 10px;
            border-radius: 10px;
            margin-bottom: 8px;
        }
        .ogrenci-item small { display:block; }
        .row-btns { display:flex; gap:8px; margin-top:8px; }
        .row-btns button { flex:1; padding:10px; font-size:0.9rem; }

        .ogrenci-card {
            background: #fff;
            padding: 16px;
            border-radius: 12px;
            margin-bottom: 12px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.12);
        }
        .card-btns {
            display: flex;
            gap: 12px;
            margin-top: 10px;
        }
        .card-btns button { flex:1; font-size:1.4rem; padding:18px; }

        @media (max-width: 768px) {
            body { background:#1e1e1e; color:#f1f1f1; }
            .section { background:#2c2c2c; }
        }
    </style>
</head>
<body>

<h1>ğŸ“˜ Ã–dev Takip Sistemi</h1>
<p id="baslikBilgi" style="text-align:center;font-weight:bold"></p>

<div class="section">
    <h2>ğŸ« Ã–ÄŸrenci YÃ¶netimi</h2>
    <label>Ad Soyad</label>
    <input id="ad">
    <label>Numara</label>
    <input id="no">
    <label>SÄ±nÄ±f</label>
    <input id="sinif">

    <button onclick="kaydetVeyaGuncelle()" id="kaydetBtn">Kaydet</button>
    <button class="secondary" onclick="iptal()">Ä°ptal</button>

    <div id="ogrenciListesi"></div>
</div>

<div class="section">
    <h2>ğŸ« Okul / Ã–ÄŸretmen Bilgileri</h2>
    <label>Okul AdÄ±</label>
    <input id="okulAdi">
    <label>Ã–ÄŸretmen AdÄ±</label>
    <input id="ogretmenAdi">
    <button onclick="bilgiKaydet()">Kaydet</button>
</div>

<div class="section">
    <h2>ğŸ“Š Raporlama & Yedekleme</h2>
    <label>Ay SeÃ§</label>
    <input type="month" id="raporAy">
    <button onclick="aylikPdfRapor()">ğŸ§¾ AylÄ±k PDF Rapor</button>
    <button class="secondary" onclick="yedekAl()">â˜ï¸ iCloud / Drive Yedek Al</button>
    <button class="secondary" onclick="yedektenYukle()">ğŸ“¥ Yedekten Geri YÃ¼kle</button>
</div>

<div class="section">
    <h2>ğŸ“± HÄ±zlÄ± Ã–dev GiriÅŸi</h2>
    <select id="hizliSinif" onchange="hizliListeGuncelle()"></select>
    <button class="secondary" onclick="geriAl()">â†©ï¸ Son Ä°ÅŸlemi Geri Al</button>
    <div id="hizliOgrenciListesi"></div>
</div>

<script>
let ogrenciler = JSON.parse(localStorage.getItem('ogrenciler')) || [];
let odevler = JSON.parse(localStorage.getItem('odevler')) || [];
let seciliNo = null;
let sonIslem = null;

function kaydetVeyaGuncelle(){
    const ad = adInp.value;
    const no = noInp.value;
    const sinif = sinifInp.value;
    if(!ad || !no || !sinif) return alert('TÃ¼m alanlarÄ± doldurun');

    if(seciliNo){
        const o = ogrenciler.find(x=>x.no===seciliNo);
        o.ad = ad; o.no = no; o.sinif = sinif;
        seciliNo = null;
        kaydetBtn.textContent = 'Kaydet';
    } else {
        ogrenciler.push({ad,no,sinif});
    }
    localStorage.setItem('ogrenciler', JSON.stringify(ogrenciler));
    temizle();
    listele();
    siniflariDoldur();
}

function duzenle(no){
    const o = ogrenciler.find(x=>x.no===no);
    adInp.value=o.ad; noInp.value=o.no; sinifInp.value=o.sinif;
    seciliNo=no;
    kaydetBtn.textContent='GÃ¼ncelle';
}

function sil(no){
    const ogr = ogrenciler.find(o=>o.no===no);
    const odevSayisi = odevler.filter(o=>o.no===no).length;
    modalAc({
        text:`${ogr.ad} adlÄ± Ã¶ÄŸrenciyi silmek istiyor musunuz?`,
        info: odevSayisi>0 ? `${odevSayisi} adet Ã¶dev kaydÄ± da silinecek.` : '',
        pin:true,
        onay:()=>{
            ogrenciler = ogrenciler.filter(o=>o.no!==no);
            odevler = odevler.filter(o=>o.no!==no);
            localStorage.setItem('ogrenciler', JSON.stringify(ogrenciler));
            localStorage.setItem('odevler', JSON.stringify(odevler));
            listele(); siniflariDoldur();

function bilgiKaydet(){
    okulBilgi = { okul: okulAdi.value, ogretmen: ogretmenAdi.value };
    localStorage.setItem('okulBilgi', JSON.stringify(okulBilgi));
    baslikGuncelle();
}

function baslikGuncelle(){
    if(okulBilgi.okul || okulBilgi.ogretmen){
        baslikBilgi.textContent = `${okulBilgi.okul || ''} â€“ ${okulBilgi.ogretmen || ''}`;
        okulAdi.value = okulBilgi.okul || '';
        ogretmenAdi.value = okulBilgi.ogretmen || '';
    }
}

baslikGuncelle();

function aylikPdfRapor(){
    const okul = okulBilgi.okul || '';
    const ogretmen = okulBilgi.ogretmen || '';

    const ay = raporAy.value;
    if(!ay) return alert('Ay seÃ§iniz');
    let html = `<h2>${okul}</h2><h3>${ogretmen}</h3><hr><h2>AylÄ±k Ã–dev Raporu (${ay})</h2>` +<h2>AylÄ±k Ã–dev Raporu (${ay})</h2><table border="1" cellpadding="6" cellspacing="0" width="100%">
    <tr><th>SÄ±nÄ±f</th><th>Ã–ÄŸrenci</th><th>No</th><th>Tarih</th><th>Durum</th></tr>`;

    odevler.filter(o=>o.tarih.startsWith(ay)).forEach(o=>{
        const ogr = ogrenciler.find(x=>x.no===o.no);
        if(!ogr) return;
        html += `<tr><td>${ogr.sinif}</td><td>${ogr.ad}</td><td>${ogr.no}</td><td>${o.tarih}</td><td>${o.yapti?'YaptÄ±':'YapmadÄ±'}</td></tr>`;
    });
    html += '</table>';
    const w = window.open('','_blank');
    w.document.write(`<html><body>${html}</body></html>`);
    w.document.close();
    w.print();
}

function yedekAl(){
    const data = { ogrenciler, odevler, tarih:new Date().toISOString() };
    const blob = new Blob([JSON.stringify(data)], {type:'application/json'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'odev_yedek.json';
    a.click();
}

function yedektenYukle(){
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = '.json';
    input.onchange = e => {
        const file = e.target.files[0];
        const r = new FileReader();
        r.onload = () => {
            const d = JSON.parse(r.result);
            ogrenciler = d.ogrenciler || [];
            odevler = d.odevler || [];
            localStorage.setItem('ogrenciler', JSON.stringify(ogrenciler));
            localStorage.setItem('odevler', JSON.stringify(odevler));
            listele(); siniflariDoldur();
            alert('Yedek geri yÃ¼klendi');
        };
        r.readAsText(file);
    };
    input.click();
}

            geriAlHazirla({tip:'sil',ogr});
        }
    });
});
}

function listele(){
    ogrenciListesi.innerHTML='';
    ogrenciler.forEach(o=>{
        const d=document.createElement('div');
        d.className='ogrenci-item';
        d.innerHTML=`<b>${o.ad}</b><small>No:${o.no} | ${o.sinif}</small>
        <div class='row-btns'>
            <button onclick="duzenle('${o.no}')">âœï¸ GÃ¼ncelle</button>
            <button class='danger' onclick="sil('${o.no}')">ğŸ—‘ï¸ Sil</button>
        </div>`;
        ogrenciListesi.appendChild(d);
    });
}

function temizle(){ adInp.value=''; noInp.value=''; sinifInp.value=''; }
function iptal(){ temizle(); seciliNo=null; kaydetBtn.textContent='Kaydet'; }

function siniflariDoldur(){
    hizliSinif.innerHTML='<option value="">SÄ±nÄ±f SeÃ§</option>';
    [...new Set(ogrenciler.map(o=>o.sinif))].forEach(s=>{
        hizliSinif.innerHTML+=`<option>${s}</option>`;
    });
}

function hizliListeGuncelle(){
    hizliOgrenciListesi.innerHTML='';
    const sinif=hizliSinif.value;
    const tarih=new Date().toISOString().split('T')[0];
    ogrenciler.filter(o=>o.sinif===sinif).forEach(o=>{
        const d=document.createElement('div');
        d.className='ogrenci-card';
        d.innerHTML=`<b>${o.ad}</b><small>No:${o.no}</small>
        <div class='card-btns'>
            <button onclick="kaydet('${o.no}',true)">âœ…</button>
            <button onclick="kaydet('${o.no}',false)">âŒ</button>
        </div>`;
        hizliOgrenciListesi.appendChild(d);
    });
}

function kaydet(no,yapti){
    const tarih=new Date().toISOString().split('T')[0];
    sonIslem={no,tarih};
    const i=odevler.findIndex(o=>o.no===no&&o.tarih===tarih);
    if(i>-1) odevler[i].yapti=yapti;
    else odevler.push({no,tarih,yapti});
    localStorage.setItem('odevler',JSON.stringify(odevler));
}

function geriAl(){
    if(!sonIslem) return;
    odevler=odevler.filter(o=>!(o.no===sonIslem.no&&o.tarih===sonIslem.tarih));
    localStorage.setItem('odevler',JSON.stringify(odevler));
    sonIslem=null;
}

const adInp=ad,noInp=no,sinifInp=sinif;
const ADMIN_PIN = '1234';
let okulBilgi = JSON.parse(localStorage.getItem('okulBilgi')) || {};
let geriAlZamanlayici = null;

function modalAc({text,info='',pin=false,onay}){
    modalText.textContent = text;
    modalInfo.textContent = info;
    modalPin.style.display = pin ? 'block' : 'none';
    modalPin.value='';
    modal.style.display='flex';
    modalOk.onclick = ()=>{
        if(pin && modalPin.value!==ADMIN_PIN){
            alert('PIN hatalÄ±'); return;
        }
        modalKapat(); onay();
    };
}
function modalKapat(){ modal.style.display='none'; }

function geriAlHazirla(veri){
    sonIslem = veri;
    clearTimeout(geriAlZamanlayici);
    geriAlZamanlayici = setTimeout(()=>sonIslem=null,5000);
    alert('Ä°ÅŸlem yapÄ±ldÄ±. 5 saniye iÃ§inde geri alabilirsiniz.');
}

// GÃ¼ncelleme iÃ§in onay ekleme
function kaydetVeyaGuncelle(){
    const ad = adInp.value;
    const no = noInp.value;
    const sinif = sinifInp.value;
    if(!ad || !no || !sinif) return alert('TÃ¼m alanlarÄ± doldurun');

    if(seciliNo){
        modalAc({
            text:'Ã–ÄŸrenci bilgileri gÃ¼ncellensin mi?',
            onay:()=>{
                const o = ogrenciler.find(x=>x.no===seciliNo);
                o.ad = ad; o.no = no; o.sinif = sinif;
                seciliNo=null; kaydetBtn.textContent='Kaydet';
                localStorage.setItem('ogrenciler', JSON.stringify(ogrenciler));
                temizle(); listele(); siniflariDoldur();
            }
        });
    } else {
        ogrenciler.push({ad,no,sinif});
        localStorage.setItem('ogrenciler', JSON.stringify(ogrenciler));
        temizle(); listele(); siniflariDoldur();
    }
}

// Geri Al geniÅŸletme
function geriAl(){
    if(!sonIslem) return alert('Geri alÄ±nacak iÅŸlem yok');
    if(sonIslem.tip==='sil'){
        ogrenciler.push(sonIslem.ogr);
        localStorage.setItem('ogrenciler', JSON.stringify(ogrenciler));
        listele(); siniflariDoldur();
    }
    sonIslem=null;
}

listele(); siniflariDoldur();
