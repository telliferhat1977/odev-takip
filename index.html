<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Ã–dev ve DavranÄ±ÅŸ Takip</title>

<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#3498db">
<link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/3407/3407024.png">

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>

<style>
:root { --primary: #3498db; --secondary: #7f8c8d; --danger: #e74c3c; --success: #2ecc71; --bg: #f0f2f5; }
body { font-family: sans-serif; background: var(--bg); margin: 0; padding: 10px; -webkit-tap-highlight-color: transparent; }
.section { background: #fff; padding: 15px; margin-bottom: 15px; border-radius: 16px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
input, select, button { width: 100%; padding: 12px; margin: 5px 0; border-radius: 10px; border: 1px solid #ddd; font-size: 16px; box-sizing: border-box; }
button { background: var(--primary); color: #fff; border: none; font-weight: bold; cursor: pointer; transition: 0.2s; display: flex; justify-content: center; align-items: center; gap: 8px; }
button:active { transform: scale(0.98); }
.danger { background: var(--danger) !important; }
.success { background: var(--success) !important; }
.secondary { background: var(--secondary) !important; }
.btn-row { display: flex; gap: 10px; }
.hidden { display: none; }
h2 { color: #2c3e50; border-bottom: 2px solid var(--primary); padding-bottom: 5px; margin-top: 0; font-size: 1.2rem; }
.ogrenci-kart { background: #f9f9f9; padding: 15px; border-radius: 12px; margin-top: 8px; border-left: 5px solid var(--primary); box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
label { font-size: 13px; color: var(--secondary); font-weight: bold; }
</style>
</head>
<body>

<div id="karsilamaEkrani" class="section">
    <h1>ğŸ« Kurulum</h1>
    <input id="okulAd" placeholder="Okul AdÄ±">
    <input id="ogretmenAd" placeholder="Ã–ÄŸretmen AdÄ±">
    <button id="karsilamaKaydet">Kurulumu Tamamla</button>
</div>

<div id="mainApp" class="hidden">
    <h1 id="okulBaslik" style="text-align:center; font-size:1.2rem; margin-bottom: 5px;"></h1>
    <h2 id="ogretmenBaslik" style="text-align:center; font-size:1rem; color:var(--secondary); border:none; margin-bottom:15px;"></h2>
    
    <div class="section">
        <h2>ğŸ‘¨â€ğŸ“ Ã–ÄŸrenci YÃ¶netimi</h2>
        <input id="ad" placeholder="Ad Soyad">
        <input id="no" placeholder="Numara">
        <input id="sinif" placeholder="SÄ±nÄ±f (Ã–rn: 9/A)">
        <div class="btn-row">
            <button id="kaydetBtn">ğŸ’¾ Kaydet</button>
            <button id="iptalBtn" class="secondary">Ä°ptal</button>
        </div>
        <hr style="border:0; border-top:1px solid #eee; margin:15px 0">
        <input id="arama" placeholder="ğŸ” Ä°sim veya No ile Ara...">
        <div id="aramaSonuc"></div>
    </div>

    <div class="section">
        <h2>ğŸ“‹ Ã–dev & DavranÄ±ÅŸ Kontrol</h2>
        <label>Tarih:</label>
        <input type="date" id="islemTarih">
        <select id="islemSinif"><option value="">SÄ±nÄ±f SeÃ§in</option></select>
        <select id="islemOgrenciSec" size="5"></select>
        
        <div id="kontrolAlanlari" class="hidden">
            <p style="margin:10px 0 5px 0"><b>Ã–dev Durumu:</b></p>
            <div class="btn-row">
                <button onclick="veriKaydet('odev','YaptÄ±')" class="success">âœ… YaptÄ±</button>
                <button onclick="veriKaydet('odev','YapmadÄ±')" class="danger">âŒ YapmadÄ±</button>
                <button onclick="veriKaydet('odev','Gelmedi')" class="secondary">ğŸš« Gelmedi</button>
            </div>
            <p style="margin:10px 0 5px 0"><b>SÄ±nÄ±f Ä°Ã§i DavranÄ±ÅŸ:</b></p>
            <div class="btn-row">
                <button onclick="veriKaydet('davranis','+')" class="success" style="font-size:24px">+</button>
                <button onclick="veriKaydet('davranis','-')" class="danger" style="font-size:24px">-</button>
            </div>
        </div>
    </div>

    <div class="section">
        <h2>ğŸ“Š PDF RaporlarÄ±</h2>
        <select id="raporSinif"><option value="">Rapor Ä°Ã§in SÄ±nÄ±f SeÃ§</option></select>
        <button onclick="gunlukPdf()">ğŸ“„ GÃ¼nlÃ¼k Rapor (BugÃ¼n)</button>
        <hr style="border:0; border-top:1px solid #eee; margin:15px 0">
        <input type="month" id="raporAy">
        <button onclick="aylikPdf()" class="secondary">ğŸ“… AylÄ±k Rapor Al</button>
    </div>

    <div class="section">
        <h2>ğŸ’¾ Veri YÃ¶netimi</h2>
        <button onclick="jsonYedekAl()">â¬‡ï¸ Yedek Ä°ndir (JSON)</button>
        <div style="margin-top:15px">
            <label>Yedek DosyasÄ± SeÃ§:</label>
            <input type="file" id="jsonFile" accept="application/json">
            <button class="secondary" onclick="jsonYukle()">â¬†ï¸ Yedekten YÃ¼kle</button>
        </div>
    </div>
</div>

<script>
let okulAd = localStorage.getItem('okulAd') || '';
let ogretmenAd = localStorage.getItem('ogretmenAd') || '';
let ogrenciler = JSON.parse(localStorage.getItem('ogrenciler')) || [];
let odevler = JSON.parse(localStorage.getItem('odevler')) || [];
let davranislar = JSON.parse(localStorage.getItem('davranislar')) || [];
let seciliNo = null; // GÃ¼ncelleme takibi iÃ§in

const bugunISO = new Date().toISOString().split('T')[0];
document.getElementById('islemTarih').value = bugunISO;
document.getElementById('islemTarih').max = bugunISO;

function karsilamaGoster(){
    if(okulAd){
        document.getElementById('okulBaslik').textContent = "ğŸ« " + okulAd;
        document.getElementById('ogretmenBaslik').textContent = "ğŸ‘©â€ğŸ« " + ogretmenAd;
        document.getElementById('karsilamaEkrani').classList.add('hidden');
        document.getElementById('mainApp').classList.remove('hidden');
        siniflariDoldur();
    }
}
karsilamaGoster();

document.getElementById('karsilamaKaydet').onclick = () => {
    okulAd = document.getElementById('okulAd').value.trim();
    ogretmenAd = document.getElementById('ogretmenAd').value.trim();
    if(!okulAd || !ogretmenAd) return alert("LÃ¼tfen alanlarÄ± doldurun.");
    localStorage.setItem('okulAd', okulAd);
    localStorage.setItem('ogretmenAd', ogretmenAd);
    karsilamaGoster();
};

function siniflariDoldur(){
    const siniflar = [...new Set(ogrenciler.map(o => o.sinif.toUpperCase()))];
    ['islemSinif', 'raporSinif'].forEach(sId => {
        const s = document.getElementById(sId);
        s.innerHTML = '<option value="">SÄ±nÄ±f SeÃ§in</option>';
        siniflar.forEach(sinif => s.innerHTML += `<option value="${sinif}">${sinif}</option>`);
    });
}

document.getElementById('islemSinif').onchange = function() {
    const sOgr = document.getElementById('islemOgrenciSec');
    sOgr.innerHTML = '';
    ogrenciler.filter(o => o.sinif.toUpperCase() === this.value).forEach(o => {
        sOgr.innerHTML += `<option value="${o.no}">${o.ad} (${o.no})</option>`;
    });
};

document.getElementById('islemOgrenciSec').onchange = () => {
    document.getElementById('kontrolAlanlari').classList.remove('hidden');
};

function veriKaydet(tip, deger) {
    const no = document.getElementById('islemOgrenciSec').value;
    const tarih = document.getElementById('islemTarih').value;
    if(!no) return;
    if(tarih > bugunISO) return alert("Gelecek tarihe iÅŸlem yapÄ±lamaz!");

    if(tip === 'odev') {
        const idx = odevler.findIndex(o => o.no === no && o.tarih === tarih);
        if(idx > -1) odevler[idx].durum = deger; else odevler.push({no, tarih, durum: deger});
        localStorage.setItem('odevler', JSON.stringify(odevler));
    } else {
        const idx = davranislar.findIndex(d => d.no === no && d.tarih === tarih);
        if(idx > -1) davranislar[idx].puan = deger; else davranislar.push({no, tarih, puan: deger});
        localStorage.setItem('davranislar', JSON.stringify(davranislar));
    }
    const btn = event.target;
    const old = btn.innerText; btn.innerText = "OK"; setTimeout(()=>btn.innerText=old, 700);
}

// Ã–ÄRENCÄ° SÄ°LME VE GÃœNCELLEME FONKSÄ°YONLARI
function ogrenciDuzenle(no) {
    const ogr = ogrenciler.find(o => o.no === no);
    if(!ogr) return;
    document.getElementById('ad').value = ogr.ad;
    document.getElementById('no').value = ogr.no;
    document.getElementById('sinif').value = ogr.sinif;
    seciliNo = no;
    document.getElementById('kaydetBtn').innerHTML = "ğŸ”„ GÃ¼ncelle";
    window.scrollTo({ top: 0, behavior: 'smooth' });
}

function ogrenciSil(no) {
    if(!confirm("Ã–ÄŸrenciyi ve tÃ¼m kayÄ±tlarÄ±nÄ± silmek istediÄŸinize emin misiniz?")) return;
    ogrenciler = ogrenciler.filter(o => o.no !== no);
    odevler = odevler.filter(o => o.no !== no);
    davranislar = davranislar.filter(o => o.no !== no);
    
    localStorage.setItem('ogrenciler', JSON.stringify(ogrenciler));
    localStorage.setItem('odevler', JSON.stringify(odevler));
    localStorage.setItem('davranislar', JSON.stringify(davranislar));
    
    siniflariDoldur();
    aramaYap(); // Listeyi yenile
    alert("Ã–ÄŸrenci silindi.");
}

function formatTarih(t) { if(!t) return ""; const [y,a,g] = t.split('-'); return `${g}/${a}/${y.slice(2)}`; }

function gunlukPdf() {
    const sinif = document.getElementById('raporSinif').value;
    if(!sinif) return alert("SÄ±nÄ±f seÃ§in");
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    const liste = ogrenciler.filter(o => o.sinif.toUpperCase() === sinif.toUpperCase());
    const rows = liste.map(o => {
        const od = odevler.find(x => x.no === o.no && x.tarih === bugunISO);
        const dv = davranislar.find(x => x.no === o.no && x.tarih === bugunISO);
        return [o.no, o.ad, od ? od.durum : 'Girilmedi', dv ? dv.puan : '-'];
    });
    doc.setFontSize(14);
    doc.text(`${sinif} - GÃ¼nlÃ¼k Rapor - ${formatTarih(bugunISO)}`, 14, 15);
    doc.autoTable({ head: [['No', 'Ad Soyad', 'Ã–dev', 'DavranÄ±ÅŸ']], body: rows, startY: 28 });
    doc.save(`Gunluk_${sinif}.pdf`);
}

function aylikPdf() {
    const ay = document.getElementById('raporAy').value;
    const sinif = document.getElementById('raporSinif').value;
    if(!ay || !sinif) return alert("Ay ve SÄ±nÄ±f seÃ§in");
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF('l', 'mm', 'a4');
    const liste = ogrenciler.filter(o => o.sinif.toUpperCase() === sinif.toUpperCase());
    const nolar = liste.map(o => o.no);
    const tarihler = [...new Set([...odevler, ...davranislar].filter(x => nolar.includes(x.no) && x.tarih.startsWith(ay)).map(x => x.tarih))].sort();
    if(tarihler.length === 0) return alert("Bu ay iÃ§in veri bulunamadÄ±.");
    const head1 = ['No', 'Ad Soyad'];
    const head2 = ['', ''];
    tarihler.forEach(t => { head1.push(formatTarih(t), ''); head2.push('Ã–dev', 'Dav.'); });
    const rows = liste.map(o => {
        const row = [o.no, o.ad];
        tarihler.forEach(t => {
            const od = odevler.find(x => x.no === o.no && x.tarih === t);
            const dv = davranislar.find(x => x.no === o.no && x.tarih === t);
            row.push(od ? od.durum : '-', dv ? dv.puan : '-');
        });
        return row;
    });
    doc.text(`${sinif} - AylÄ±k Rapor (${ay})`, 14, 15);
    doc.autoTable({ head: [head1, head2], body: rows, startY: 20, styles: { fontSize: 6 }, theme: 'grid' });
    doc.save(`Aylik_${sinif}.pdf`);
}

document.getElementById('kaydetBtn').onclick = () => {
    const ad = document.getElementById('ad').value.trim();
    const no = document.getElementById('no').value.trim();
    const sinif = document.getElementById('sinif').value.trim().toUpperCase();
    if(!ad || !no || !sinif) return alert("Eksik bilgi!");

    if(seciliNo) {
        // GÃœNCELLEME
        const idx = ogrenciler.findIndex(o => o.no === seciliNo);
        ogrenciler[idx] = {ad, no, sinif};
        seciliNo = null;
        document.getElementById('kaydetBtn').innerHTML = "ğŸ’¾ Kaydet";
    } else {
        // YENÄ° KAYIT
        if(ogrenciler.some(o=>o.no === no)) return alert("Bu numara zaten kayÄ±tlÄ±!");
        ogrenciler.push({ad, no, sinif});
    }
    
    localStorage.setItem('ogrenciler', JSON.stringify(ogrenciler));
    document.getElementById('ad').value = ''; document.getElementById('no').value = '';
    siniflariDoldur();
    alert("Ä°ÅŸlem BaÅŸarÄ±lÄ±");
    document.getElementById('aramaSonuc').innerHTML = '';
};

document.getElementById('iptalBtn').onclick = () => {
    document.getElementById('ad').value = '';
    document.getElementById('no').value = '';
    document.getElementById('sinif').value = '';
    seciliNo = null;
    document.getElementById('kaydetBtn').innerHTML = "ğŸ’¾ Kaydet";
};

function aramaYap() {
    const q = document.getElementById('arama').value.toLowerCase();
    const res = document.getElementById('aramaSonuc');
    res.innerHTML = '';
    if(q.length < 1) return;
    
    ogrenciler.filter(o => o.ad.toLowerCase().includes(q) || o.no.includes(q)).forEach(o => {
        res.innerHTML += `
            <div class="ogrenci-kart">
                <b>${o.ad}</b> (${o.no}) - ${o.sinif}
                <div class="btn-row" style="margin-top:10px">
                    <button onclick="ogrenciDuzenle('${o.no}')" style="font-size:12px; padding:8px;">âœï¸ DÃ¼zenle</button>
                    <button onclick="ogrenciSil('${o.no}')" class="danger" style="font-size:12px; padding:8px;">ğŸ—‘ï¸ Sil</button>
                </div>
            </div>`;
    });
}

document.getElementById('arama').oninput = aramaYap;

function jsonYedekAl(){
    const data = {ogrenciler, odevler, davranislar, okulAd, ogretmenAd};
    const blob = new Blob([JSON.stringify(data)], {type: 'application/json'});
    const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `yedek.json`; a.click();
}

function jsonYukle(){
    const file = document.getElementById('jsonFile').files[0];
    if(!file) return alert("Dosya seÃ§ilmedi!");
    const reader = new FileReader();
    reader.onload = (e) => {
        const data = JSON.parse(e.target.result);
        localStorage.setItem('ogrenciler', JSON.stringify(data.ogrenciler || []));
        localStorage.setItem('odevler', JSON.stringify(data.odevler || []));
        localStorage.setItem('davranislar', JSON.stringify(data.davranislar || []));
        localStorage.setItem('okulAd', data.okulAd || '');
        localStorage.setItem('ogretmenAd', data.ogretmenAd || '');
        location.reload();
    };
    reader.readAsText(file);
}
</script>
</body>
</html>
