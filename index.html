<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ödev Takip Sistemi</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<style>
*{box-sizing:border-box}
body{font-family:Arial,Helvetica,sans-serif;background:#f2f4f7;margin:0;padding:8px}
h1,h2,h3{text-align:center;margin:6px 0}
.section{background:#fff;padding:12px;margin-bottom:12px;border-radius:14px;box-shadow:0 4px 12px rgba(0,0,0,.08)}
input,select,button{width:100%;padding:12px;margin-top:6px;margin-bottom:10px;font-size:1rem;border-radius:10px;border:1px solid #ccc}
button{border:none;background:#3498db;color:#fff;font-weight:bold}
button.secondary{background:#7f8c8d}
button.danger{background:#e74c3c}
.row{display:flex;gap:8px}
.row button{flex:1}
#baslikEkran{position:sticky;top:0;background:#3498db;color:#fff;padding:8px;border-radius:0 0 14px 14px;z-index:10}
small{color:#eaf2f8}
</style>
</head>
<body>

<div id="baslikEkran" style="display:none">
  <h3 id="okulAdi"></h3>
  <small id="ogretmenAdi"></small>
</div>

<div id="ilkAcilis" class="section">
<h2>Okul ve Öğretmen Bilgileri</h2>
<input id="okulInput" placeholder="Okul Adı">
<input id="ogretmenInput" placeholder="Öğretmen Adı">
<button id="ilkKaydetBtn">Kaydet</button>
</div>

<div id="anaEkran" style="display:none">
<h2>Ödev Takip Sistemi</h2>

<div class="section">
<h3>Öğrenci Yönetimi</h3>
<input id="ad" placeholder="Ad Soyad">
<input id="no" placeholder="Numara">
<input id="sinif" placeholder="Sınıf (9/C)">
<div class="row">
<button id="kaydetBtn">Kaydet / Güncelle</button>
<button id="iptalBtn" class="secondary">İptal</button>
</div>
<input id="arama" placeholder="Ara (ad / no)">
<div id="aramaSonuc"></div>
<div class="row" id="duzenButonlari" style="display:none">
<button class="danger" onclick="ogrenciSil()">Sil</button>
</div>
</div>

<div class="section">
<h3>Ödev Kontrol</h3>
<input type="date" id="odevTarih">
<select id="odevSinif"></select>
<select id="odevOgrenciSec" size="6"></select>
<div id="odevIslem"></div>
</div>

<div class="section">
<h3>PDF Rapor</h3>
<label>Günlük</label>
<input type="date" id="gunlukPdfTarih">
<button onclick="gunlukPdf()">Günlük PDF</button>
<label>Aylık</label>
<input type="month" id="raporAy">
<button onclick="aylikPdf()">Aylık PDF</button>
</div>

<div class="section">
<h3>Yedekleme</h3>
<button onclick="jsonYedekAl()">JSON Yedek Al</button>
<input type="file" id="jsonFile" accept="application/json">
<button class="secondary" onclick="jsonYukle()">Yedekten Yükle</button>
</div>
</div>

<script>
/**************** FONT ****************/
const DEJAVU_BASE64 = "AAEAAAALAIAAAwAwT1MvMg8SBJkAAAC8AAAAYGNtYXAa8xXhAAABHAAAAFRnYXNwAAAAEAAAAXgAAAAIZ2x5Zg8e5l4AAAF8AAABmGhlYWQY1+JmAAACyAAAADZoaGVhB6kE0gAAANgAAAAkaG10eBYAAB8AAAD8AAAALGxvY2ED5gJCAAABRAAAABxtYXhwAAgAKwAAAUgAAAAgbmFtZb0Fq5MAAAF4AAABznBvc3QAAwAAAAAEoAAAACAAAwPpAZAABQAAAUwAAAAgAAAAAAAAAAAAAAAAAAAAAQAAAAAAAAAAAAAAAAAAAAD//wADAAEAAAAAAAAAAQAAAAAAAAAAAAAAAAAAAAEAAAAAAAAAAAAAAAAAAAABAAAAAAAAAAAAAAAAAAAAAQAAAAAAAAAAAAAAAAAAAAAQ==";

/**************** VERİLER ****************/
let ogrenciler = JSON.parse(localStorage.getItem('ogrenciler')) || [];
let odevler = JSON.parse(localStorage.getItem('odevler')) || [];
let okulAdi = localStorage.getItem('okulAdi') || '';
let ogretmenAdi = localStorage.getItem('ogretmenAdi') || '';
let seciliNo = null;

const maxDate = new Date().toISOString().split('T')[0];
document.getElementById('odevTarih').max = maxDate;

/**************** BAŞLANGIÇ ****************/
function baslikGoster(){
 document.getElementById('okulAdi').textContent = okulAdi;
 document.getElementById('ogretmenAdi').textContent = ogretmenAdi;
 document.getElementById('baslikEkran').style.display='block';
}

if(okulAdi && ogretmenAdi){
 ilkAcilis.style.display='none';
 anaEkran.style.display='block';
 baslikGoster();
}

ilkKaydetBtn.onclick = ()=>{
 if(!okulInput.value || !ogretmenInput.value) return alert('Alanları doldurun');
 localStorage.setItem('okulAdi', okulInput.value);
 localStorage.setItem('ogretmenAdi', ogretmenInput.value);
 okulAdi = okulInput.value; ogretmenAdi = ogretmenInput.value;
 ilkAcilis.style.display='none'; anaEkran.style.display='block'; baslikGoster();
}

/**************** SINIF LİSTESİ ****************/
function siniflariYukle(){
 const select=document.getElementById('odevSinif');
 select.innerHTML='<option value="">Sınıf Seç</option>';
 [...new Set(ogrenciler.map(o=>o.sinif))].forEach(s=>{
  const op=document.createElement('option'); op.value=s; op.textContent=s; select.appendChild(op);
 });
}

odevSinif.onchange=()=>{
 const s=odevSinif.value;
 const list=document.getElementById('odevOgrenciSec');
 list.innerHTML='';
 ogrenciler.filter(o=>o.sinif===s).forEach(o=>{
  const op=document.createElement('option');
  op.value=o.no;
  op.textContent=`${o.ad} (${o.no})`;
  list.appendChild(op);
 });
};

document.getElementById('odevOgrenciSec').onchange=()=>{
 const alan=document.getElementById('odevIslem');
 alan.innerHTML='';
 const tarih=odevTarih.value;
 if(!tarih) return alert('Tarih seç');
 ['yapti','yapmadi','gelmedi'].forEach(d=>{
  const b=document.createElement('button');
  b.textContent=d==='yapti'?'Yaptı':d==='yapmadi'?'Yapmadı':'Gelmedi';
  b.onclick=()=>{
   const no=odevOgrenciSec.value;
   odevler=odevler.filter(o=>!(o.no===no&&o.tarih===tarih));
   odevler.push({no,tarih,durum:d});
   localStorage.setItem('odevler',JSON.stringify(odevler));
   alert('Kaydedildi');
  };
  alan.appendChild(b);
 });
};

siniflariYukle();

/**** ARAMA ****/
arama.oninput=()=>{
 const q=arama.value.toLowerCase();
 const alan=document.getElementById('aramaSonuc');
 alan.innerHTML='';
 if(!q) return;
 ogrenciler.filter(o=>o.ad.toLowerCase().includes(q)||o.no.includes(q))
 .forEach(o=>{
  const d=document.createElement('div'); d.className='ogrenci';
  d.textContent=`${o.ad} (${o.no})`;
  d.onclick=()=>{
   ad.value=o.ad; no.value=o.no; sinif.value=o.sinif; seciliNo=o.no;
   document.getElementById('duzenButonlari').style.display='flex';
  };
  alan.appendChild(d);
 });
};

function ogrenciSil(){
 if(!seciliNo) return;
 ogrenciler=ogrenciler.filter(o=>o.no!==seciliNo);
 odevler=odevler.filter(o=>o.no!==seciliNo);
 localStorage.setItem('ogrenciler',JSON.stringify(ogrenciler));
 localStorage.setItem('odevler',JSON.stringify(odevler));
 location.reload();
}



/**************** PDF ****************/
function pdfHazirla(orientation='p'){
 const { jsPDF } = window.jspdf;
 const doc = new jsPDF({orientation});
 doc.addFileToVFS('DejaVuSans.ttf', DEJAVU_BASE64);
 doc.addFont('DejaVuSans.ttf','DejaVu','normal');
 doc.setFont('DejaVu');
 return doc;
}

function durumRenk(durum){
 if(durum==='yapti') return [46,204,113];
 if(durum==='yapmadi') return [231,76,60];
 if(durum==='gelmedi') return [241,196,15];
 return null;
}

function gunlukPdf(){
 const t = gunlukPdfTarih.value; if(!t) return alert('Tarih seç');
 const siniflar=[...new Set(ogrenciler.map(o=>o.sinif))];
 siniflar.forEach(s=>{
  const doc = pdfHazirla();
  doc.setFillColor(52,152,219); doc.rect(0,0,210,20,'F');
  doc.setTextColor(255,255,255);
  doc.text(`${okulAdi} - ${ogretmenAdi}`,10,8);
  doc.text(`${s} - Günlük Ödev Raporu`,10,15);
  doc.setTextColor(0,0,0);
  let y=30;
  doc.setFillColor(220,220,220); doc.rect(10,y-6,190,8,'F');
  doc.text('No',12,y); doc.text('Ad Soyad',30,y); doc.text('Durum',160,y);
  y+=8;
  ogrenciler.filter(o=>o.sinif===s).forEach(o=>{
   const r=odevler.find(x=>x.no===o.no&&x.tarih===t);
   const durum=r?r.durum:'-';
   const renk=durumRenk(durum);
   doc.rect(10,y-6,190,8);
   if(renk){ doc.setFillColor(...renk); doc.rect(155,y-6,40,8,'F'); }
   doc.text(o.no,12,y); doc.text(o.ad,30,y);
   doc.text(durum==='-'?'-':durum==='yapti'?'Yaptı':durum==='yapmadi'?'Yapmadı':'Gelmedi',160,y);
   y+=8;
  });
  doc.save(`gunluk_${s}_${t}.pdf`);
 });
}

function aylikPdf(){
 const ay = raporAy.value; if(!ay) return alert('Ay seç');
 const siniflar=[...new Set(ogrenciler.map(o=>o.sinif))];
 siniflar.forEach(s=>{
  const doc = pdfHazirla('l');
  const tarihler=[...new Set(odevler.filter(o=>o.tarih.startsWith(ay)).map(o=>o.tarih))];
  doc.setFillColor(52,152,219); doc.rect(0,0,297,20,'F');
  doc.setTextColor(255,255,255);
  doc.text(`${okulAdi} - ${ogretmenAdi}`,10,8);
  doc.text(`${s} - Aylık Ödev Raporu`,10,15);
  doc.setTextColor(0,0,0);
  let x=10,y=30;
  doc.setFillColor(220,220,220); doc.rect(x,y-6,270,8,'F');
  doc.text('No',x+2,y); doc.text('Ad Soyad',x+20,y);
  tarihler.forEach((t,i)=>doc.text(t,x+70+i*30,y));
  y+=8;
  ogrenciler.filter(o=>o.sinif===s).forEach(o=>{
   doc.rect(x,y-6,270,8);
   doc.text(o.no,x+2,y); doc.text(o.ad,x+20,y);
   tarihler.forEach((t,i)=>{
    const r=odevler.find(x=>x.no===o.no&&x.tarih===t);
    const durum=r?r.durum:'-';
    const renk=durumRenk(durum);
    if(renk){ doc.setFillColor(...renk); doc.rect(x+65+i*30,y-6,28,8,'F'); }
    doc.text(durum==='-'?'-':durum==='yapti'?'Yaptı':durum==='yapmadi'?'Yapmadı':'Gelmedi',x+70+i*30,y);
   });
   y+=8;
  });
  doc.save(`aylik_${s}_${ay}.pdf`);
 });
}

/**************** YEDEK ****************/
function jsonYedekAl(){
 const data={ogrenciler,odevler};
 const blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'});
 const a=document.createElement('a');
 a.href=URL.createObjectURL(blob);
 a.download='odev_yedek.json';
 a.click();
}

function jsonYukle(){
 const f=document.getElementById('jsonFile').files[0];
 if(!f) return alert('Dosya seç');
 const r=new FileReader();
 r.onload=()=>{
  try{
   const d=JSON.parse(r.result);
   ogrenciler=d.ogrenciler||[];
   odevler=d.odevler||[];
   localStorage.setItem('ogrenciler',JSON.stringify(ogrenciler));
   localStorage.setItem('odevler',JSON.stringify(odevler));
   siniflariYukle();
   alert('Yüklendi');
  }catch{alert('Hatalı dosya')}
 };
 r.readAsText(f);
}
</script>
</body>
</html>
